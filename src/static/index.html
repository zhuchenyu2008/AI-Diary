<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIæ—¥è®°</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module" crossorigin src="/assets/index-DUaNkWBt.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-oWMHbS2h.css">
    <link rel="stylesheet" href="/mobile-bottom-fix.css">
  <style>
    #config-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.95);z-index:9999;display:none;animation:fadeIn 0.3s;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    #button-container{display:flex;gap:0.5rem;margin-left:auto;}
    @media(max-width:640px){#button-container{padding-right:0.5rem;}}
    @media (max-width: 640px) {
      #camera-btn, #upload-btn {
        padding: 0.5rem !important;
        font-size: 1.2rem !important;
        min-width: 2.5rem !important;
        height: 2.5rem !important;
      }
    }
    
    /* é‡å†™éƒ¨åˆ†ç§»åŠ¨ç«¯åº•éƒ¨æ ·å¼ - ç¡®ä¿ä¼˜å…ˆçº§ */
    @media (max-width: 768px) {
      .grid.grid-cols-2[role="tablist"] {
        background: #f1f5f9 !important;
        border-radius: 12px !important;
        padding: 6px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        margin: 16px 0 !important;
      }
      
      [role="tab"] {
        font-weight: 600 !important;
        letter-spacing: 0.025em !important;
      }
      
      [role="tab"][data-state="active"] {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%) !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4) !important;
      }
      
      [role="tab"][data-state="inactive"] {
        background: white !important;
        color: #475569 !important;
        border: 1px solid #cbd5e1 !important;
      }
      
      [role="tab"]:hover:not([data-state="active"]) {
        background: #f8fafc !important;
        border-color: #94a3b8 !important;
      }
    }
  </style>
  </head>
  <body>
    <div id="root"></div>
    <div id="config-overlay">
      <iframe src="/config.html" style="width:100%;height:100%;border:none;"></iframe>
    </div>
    <script>
      function openSettings(){document.getElementById('config-overlay').style.display='block';}
      function closeSettings(){document.getElementById('config-overlay').style.display='none';}
      function addSettingsButton(){
        const logoutBtn=[...document.querySelectorAll('button')].find(b=>b.textContent.trim()==='ç™»å‡º');
        if(!logoutBtn) return;
        let wrapper=document.getElementById('button-container');
        if(!wrapper){
          wrapper=document.createElement('div');
          wrapper.id='button-container';
          logoutBtn.parentNode.insertBefore(wrapper,logoutBtn);
        }
        if(logoutBtn.parentNode!==wrapper){
          wrapper.appendChild(logoutBtn);
        }
        let settingBtn=document.getElementById('settings-button');
        if(!settingBtn){
          settingBtn=logoutBtn.cloneNode(true);
          settingBtn.id='settings-button';
          settingBtn.textContent='è®¾ç½®';
          settingBtn.addEventListener('click',openSettings);
        }
        if(settingBtn.parentNode!==wrapper){
          wrapper.appendChild(settingBtn);
        }
      }
      const ob=new MutationObserver(addSettingsButton);
      ob.observe(document.getElementById('root'),{childList:true,subtree:true});
      addSettingsButton();

      function renderMarkdown() {
        const analysisElements = document.querySelectorAll('.ai-analysis-content');
        analysisElements.forEach(el => {
          if (!el.dataset.rendered) {
            el.innerHTML = marked.parse(el.textContent || '');
            el.dataset.rendered = 'true';
          }
        });
      }

      const markdownObserver = new MutationObserver(renderMarkdown);
      markdownObserver.observe(document.getElementById('root'), { childList: true, subtree: true });
      renderMarkdown();

      // å®æ—¶AIåˆ†æçŠ¶æ€æ£€æŸ¥
      let analysisCheckInterval = null;
      let isCheckingAnalysis = false;
      let checkCount = 0;
      const MAX_CHECK_COUNT = 120; // æœ€å¤šæ£€æŸ¥3åˆ†é’Ÿ (120 * 1.5ç§’)
      
      function startAnalysisStatusCheck(forceStart = false) {
        if (isCheckingAnalysis && !forceStart) {
          return;
        }
        
        if (analysisCheckInterval) {
          clearInterval(analysisCheckInterval);
        }
        
        isCheckingAnalysis = true;
        checkCount = 0;
        console.log('å¼€å§‹AIåˆ†æçŠ¶æ€æ£€æŸ¥...');
        
        analysisCheckInterval = setInterval(async () => {
          try {
            checkCount++;
            const response = await fetch('/api/diary/entries/today/analysis-status', {
              method: 'GET',
              credentials: 'include' // ç¡®ä¿å‘é€cookies
            });
            
            if (response.ok) {
              const data = await response.json();
              if (data.success) {
                let hasAnalyzing = false;
                let hasUpdated = false;
                let completedAnalysis = 0;
                
                data.entries.forEach(entry => {
                  if (entry.is_analyzing) {
                    hasAnalyzing = true;
                  } else if (entry.ai_analysis && !entry.ai_analysis.includes('AIåˆ†æå¤±è´¥')) {
                    completedAnalysis++;
                  }
                  // æ›´æ–°é¡µé¢ä¸­å¯¹åº”æ¡ç›®çš„AIåˆ†æå†…å®¹
                  const updated = updateEntryAnalysis(entry.id, entry.ai_analysis, entry.is_analyzing);
                  if (updated) hasUpdated = true;
                });
                
                console.log(`æ£€æŸ¥æ¬¡æ•°: ${checkCount}, æ­£åœ¨åˆ†æ: ${hasAnalyzing}, å·²æ›´æ–°: ${hasUpdated}, å®Œæˆåˆ†æ: ${completedAnalysis}`);
                
                // å¦‚æœæœ‰åˆ†æå®Œæˆä½†é¡µé¢æ²¡æœ‰åŠæ—¶æ›´æ–°ï¼Œå¼ºåˆ¶åˆ·æ–°é¡µé¢
                if (completedAnalysis > 0 && !hasAnalyzing && !hasUpdated && checkCount > 3) {
                  console.log('æ£€æµ‹åˆ°åˆ†æå®Œæˆä½†é¡µé¢æœªåŠæ—¶æ›´æ–°ï¼Œå¼ºåˆ¶åˆ·æ–°é¡µé¢...');
                  location.reload();
                  return;
                }
                
                // å¦‚æœæ²¡æœ‰æ­£åœ¨åˆ†æçš„æ¡ç›®æˆ–è¶…è¿‡æœ€å¤§æ£€æŸ¥æ¬¡æ•°ï¼Œåœæ­¢æ£€æŸ¥
                if (!hasAnalyzing || checkCount >= MAX_CHECK_COUNT) {
                  clearInterval(analysisCheckInterval);
                  analysisCheckInterval = null;
                  isCheckingAnalysis = false;
                  console.log('åœæ­¢AIåˆ†æçŠ¶æ€æ£€æŸ¥');
                }
              }
            } else {
              console.error('æ£€æŸ¥AIåˆ†æçŠ¶æ€å¤±è´¥:', response.status, response.statusText);
            }
          } catch (error) {
            console.error('æ£€æŸ¥AIåˆ†æçŠ¶æ€å¤±è´¥:', error);
            checkCount++;
            if (checkCount >= MAX_CHECK_COUNT) {
              clearInterval(analysisCheckInterval);
              analysisCheckInterval = null;
              isCheckingAnalysis = false;
            }
          }
        }, 1500); // æ¯1.5ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œæé«˜å“åº”é€Ÿåº¦
      }
      
      function updateEntryAnalysis(entryId, analysis, isAnalyzing) {
        let hasUpdated = false;
        
        // æŸ¥æ‰¾é¡µé¢ä¸­å¯¹åº”çš„AIåˆ†æå…ƒç´ å¹¶æ›´æ–°
        let analysisElements = document.querySelectorAll(`[data-entry-id="${entryId}"] .ai-analysis-content`);
        
        // å¦‚æœæ‰¾ä¸åˆ°å¸¦æœ‰data-entry-idçš„å…ƒç´ ï¼Œå°è¯•å…¶ä»–æ–¹å¼æŸ¥æ‰¾
        if (analysisElements.length === 0) {
          // æŸ¥æ‰¾æ‰€æœ‰åŒ…å«"åˆ†æä¸­"çŠ¶æ€çš„å…ƒç´ 
          const allAnalysisElements = document.querySelectorAll('.ai-analysis-content');
          allAnalysisElements.forEach(el => {
            if (el.textContent) {
              const analyzingKeywords = ['AIç†è§£ä¸­', 'AIç†è§£ä¸­...', 'åˆ†æä¸­', 'å¤„ç†ä¸­'];
              const isCurrentlyAnalyzing = analyzingKeywords.some(keyword => el.textContent.includes(keyword));
              
              if (isCurrentlyAnalyzing && el.textContent !== analysis) {
                console.log(`æ›´æ–°AIåˆ†æå†…å®¹: "${el.textContent.substring(0, 30)}..." -> "${analysis.substring(0, 30)}..."`);
                el.textContent = analysis || '';
                el.dataset.rendered = 'false';
                renderMarkdown();
                hasUpdated = true;
              }
            }
          });
        } else {
          analysisElements.forEach(el => {
            if (el.textContent !== analysis) {
              console.log(`é€šè¿‡IDæ›´æ–°AIåˆ†æå†…å®¹: ${entryId}`);
              el.textContent = analysis || '';
              el.dataset.rendered = 'false'; // é‡æ–°æ¸²æŸ“markdown
              renderMarkdown();
              hasUpdated = true;
            }
          });
        }
        
        // é¢å¤–æ£€æŸ¥ï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°å…ƒç´ ä½†æœ‰analysiså†…å®¹ï¼Œå¯èƒ½éœ€è¦åˆ·æ–°é¡µé¢
        if (!hasUpdated && analysis && !isAnalyzing && analysisElements.length === 0) {
          const analyzingElements = document.querySelectorAll('.ai-analysis-content');
          let foundAnalyzing = false;
          analyzingElements.forEach(el => {
            if (el.textContent) {
              const analyzingKeywords = ['AIç†è§£ä¸­', 'AIç†è§£ä¸­...', 'åˆ†æä¸­', 'å¤„ç†ä¸­'];
              foundAnalyzing = foundAnalyzing || analyzingKeywords.some(keyword => el.textContent.includes(keyword));
            }
          });
          
          if (foundAnalyzing) {
            console.log('æ£€æµ‹åˆ°åˆ†æå®Œæˆä½†é¡µé¢æœªæ›´æ–°ï¼Œå°è¯•åˆ·æ–°...');
            setTimeout(() => location.reload(), 1000);
            hasUpdated = true;
          }
        }
        
        return hasUpdated;
      }
      
      function checkAndStartAnalysis() {
        // æ£€æŸ¥é¡µé¢æ˜¯å¦æœ‰"AIç†è§£ä¸­"çš„å†…å®¹ï¼Œå¦‚æœæœ‰åˆ™å¼€å§‹æ£€æŸ¥
        const analyzingElements = document.querySelectorAll('.ai-analysis-content');
        let hasAnalyzing = false;
        
        analyzingElements.forEach(el => {
          if (el.textContent) {
            // æ£€æŸ¥å¤šç§"åˆ†æä¸­"çš„çŠ¶æ€
            const analyzingKeywords = ['AIç†è§£ä¸­', 'AIç†è§£ä¸­...', 'åˆ†æä¸­', 'å¤„ç†ä¸­'];
            hasAnalyzing = hasAnalyzing || analyzingKeywords.some(keyword => el.textContent.includes(keyword));
          }
        });
        
        console.log(`æ£€æŸ¥é¡µé¢åˆ†æçŠ¶æ€: å‘ç°${analyzingElements.length}ä¸ªåˆ†æå…ƒç´ , ${hasAnalyzing ? 'æœ‰' : 'æ— '}æ­£åœ¨åˆ†æçš„å†…å®¹`);
        
        if (hasAnalyzing && !isCheckingAnalysis) {
          console.log('å¼€å§‹å¯åŠ¨åˆ†æçŠ¶æ€æ£€æŸ¥...');
          startAnalysisStatusCheck();
        } else if (!hasAnalyzing && isCheckingAnalysis) {
          console.log('é¡µé¢æ— åˆ†æä¸­å†…å®¹ï¼Œåœæ­¢æ£€æŸ¥');
          if (analysisCheckInterval) {
            clearInterval(analysisCheckInterval);
            analysisCheckInterval = null;
            isCheckingAnalysis = false;
          }
        }
      }
      
      // é¡µé¢åŠ è½½æ—¶å¼€å§‹æ£€æŸ¥
      setTimeout(() => {
        checkAndStartAnalysis();
        // å¯åŠ¨å¤‡ç”¨è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
        startBackupAutoRefresh();
      }, 500);
      
      // ç›‘å¬é¡µé¢å†…å®¹å˜åŒ–ï¼Œè‡ªåŠ¨å¼€å§‹æ£€æŸ¥
      const analysisObserver = new MutationObserver(() => {
        setTimeout(checkAndStartAnalysis, 100);
        addRefreshButton(); // ç¡®ä¿åˆ·æ–°æŒ‰é’®è¢«å¢å¼º
      });
      analysisObserver.observe(document.getElementById('root'), { childList: true, subtree: true });
      
      // ç›‘å¬å‘é€æŒ‰é’®ç‚¹å‡»ï¼Œå¼€å§‹çŠ¶æ€æ£€æŸ¥å’Œå¼ºåˆ¶åˆ·æ–°
      document.addEventListener('click', (e) => {
        if (e.target.textContent && e.target.textContent.includes('å‘é€')) {
          setTimeout(() => {
            startAnalysisStatusCheck(true);
            // 5ç§’åå¼ºåˆ¶åˆ·æ–°ä¸€æ¬¡ï¼Œç¡®ä¿æ˜¾ç¤ºæ›´æ–°
            setTimeout(() => {
              console.log('5ç§’åå¼ºåˆ¶åˆ·æ–°ç¡®ä¿AIç»“æœæ˜¾ç¤º');
              location.reload();
            }, 5000);
          }, 1000);
        }
      });
      
      // æ·»åŠ æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®åŠŸèƒ½å’Œè‡ªåŠ¨åˆ·æ–°
      let autoRefreshInterval = null;
      
      function addRefreshButton() {
        const refreshBtn = [...document.querySelectorAll('button')].find(btn => 
          btn.textContent && btn.textContent.includes('åˆ·æ–°')
        );
        
        console.log('æŸ¥æ‰¾åˆ·æ–°æŒ‰é’®:', refreshBtn ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°');
        
        if (refreshBtn && !refreshBtn.dataset.enhanced) {
          refreshBtn.dataset.enhanced = 'true';
          const originalClick = refreshBtn.onclick;
          
          refreshBtn.onclick = (e) => {
            console.log('åˆ·æ–°æŒ‰é’®è¢«ç‚¹å‡»');
            // æ‰§è¡ŒåŸæœ‰çš„åˆ·æ–°åŠŸèƒ½
            if (originalClick) originalClick(e);
            
            // åˆ·æ–°åé‡æ–°å¼€å§‹æ£€æŸ¥
            setTimeout(() => {
              checkAndStartAnalysis();
            }, 1000);
          };
          
          // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
          startAutoRefresh(refreshBtn);
        }
      }
      
      function startAutoRefresh(refreshBtn) {
        // æ¸…ç†ä¹‹å‰çš„è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }
        
        console.log('å¯åŠ¨è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½');
        
        // æ¯1ç§’è‡ªåŠ¨ç‚¹å‡»åˆ·æ–°æŒ‰é’®
        autoRefreshInterval = setInterval(() => {
          // æ£€æŸ¥æ˜¯å¦æœ‰"åˆ†æä¸­"çš„å†…å®¹ï¼Œå¦‚æœæœ‰åˆ™ç‚¹å‡»åˆ·æ–°
          const analyzingElements = document.querySelectorAll('.ai-analysis-content');
          let hasAnalyzing = false;
          
          analyzingElements.forEach(el => {
            if (el.textContent) {
              const analyzingKeywords = ['AIç†è§£ä¸­', 'AIç†è§£ä¸­...', 'åˆ†æä¸­', 'å¤„ç†ä¸­'];
              if (analyzingKeywords.some(keyword => el.textContent.includes(keyword))) {
                hasAnalyzing = true;
                console.log(`å‘ç°åˆ†æä¸­çš„å†…å®¹: "${el.textContent.substring(0, 20)}..."`);
              }
            }
          });
          
          if (hasAnalyzing) {
            if (refreshBtn) {
              console.log('è‡ªåŠ¨ç‚¹å‡»åˆ·æ–°æŒ‰é’®æ›´æ–°AIåˆ†æç»“æœ');
              refreshBtn.click();
            } else {
              console.log('æœªæ‰¾åˆ°åˆ·æ–°æŒ‰é’®ï¼Œç›´æ¥é‡æ–°åŠ è½½é¡µé¢');
              location.reload();
            }
          }
        }, 1000); // æ¯1ç§’æ£€æŸ¥ä¸€æ¬¡
      }
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ·æ–°æŒ‰é’®ï¼Œå¯åŠ¨å¤‡ç”¨è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
      function startBackupAutoRefresh() {
        console.log('å¯åŠ¨å¤‡ç”¨è‡ªåŠ¨åˆ·æ–°æœºåˆ¶');
        
        setInterval(() => {
          const analyzingElements = document.querySelectorAll('.ai-analysis-content');
          let hasAnalyzing = false;
          
          analyzingElements.forEach(el => {
            if (el.textContent) {
              const analyzingKeywords = ['AIç†è§£ä¸­', 'AIç†è§£ä¸­...', 'åˆ†æä¸­', 'å¤„ç†ä¸­'];
              if (analyzingKeywords.some(keyword => el.textContent.includes(keyword))) {
                hasAnalyzing = true;
                console.log(`å¤‡ç”¨æœºåˆ¶å‘ç°åˆ†æä¸­çš„å†…å®¹: "${el.textContent.substring(0, 20)}..."`);
              }
            }
          });
          
          if (hasAnalyzing) {
            console.log('å¤‡ç”¨æœºåˆ¶ï¼šé‡æ–°åŠ è½½é¡µé¢');
            location.reload();
          }
        }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œé¿å…è¿‡äºé¢‘ç¹
      }

      // å›¾ç‰‡åŠŸèƒ½å¢å¼º
      function setupImageFeatures() {
        // æŸ¥æ‰¾æ·»åŠ å›¾ç‰‡æŒ‰é’®å¹¶æ›¿æ¢ä¸ºä¸¤ä¸ªæŒ‰é’®
        const addImageBtn = [...document.querySelectorAll('button')].find(btn => 
          btn.textContent.includes('æ·»åŠ å›¾ç‰‡') || btn.textContent.includes('æ·»åŠ ç…§ç‰‡')
        );
        
        if (addImageBtn && !document.getElementById('camera-btn')) {
          const container = addImageBtn.parentNode;
          
          // åˆ›å»ºæ‹ç…§æŒ‰é’®
          const cameraBtn = addImageBtn.cloneNode(true);
          cameraBtn.id = 'camera-btn';
          cameraBtn.innerHTML = 'ğŸ“·';
          cameraBtn.onclick = openCamera;
          
          // ä¿®æ”¹åŸæŒ‰é’®ä¸ºä¸Šä¼ å›¾ç‰‡
          addImageBtn.innerHTML = 'ğŸ–¼ï¸';
          addImageBtn.id = 'upload-btn';
          
          // æ’å…¥æ‹ç…§æŒ‰é’®
          container.insertBefore(cameraBtn, addImageBtn);
          
          // ä¸ºä¸Šä¼ æŒ‰é’®æ·»åŠ æ–‡ä»¶é€‰æ‹©åŠŸèƒ½
          addImageBtn.onclick = selectImageFile;
        }
      }

      function selectImageFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            uploadImageFile(file);
          }
        };
        input.click();
      }

      async function openCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼šæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½ï¼Œæˆ–é¡µé¢æœªåœ¨å®‰å…¨ä¸Šä¸‹æ–‡(HTTPS)ä¸­åŠ è½½ã€‚');
          return;
        }

        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } // ä¼˜å…ˆä½¿ç”¨åç½®æ‘„åƒå¤´
          });
          
          // åˆ›å»ºæ‹ç…§ç•Œé¢
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 10000; display: flex; 
            flex-direction: column; align-items: center; justify-content: center;
          `;
          
          const video = document.createElement('video');
          video.style.cssText = 'max-width: 90%; max-height: 70%; border-radius: 8px;';
          video.srcObject = stream;
          video.autoplay = true;
          video.playsInline = true;
          
          const controls = document.createElement('div');
          controls.style.cssText = 'margin-top: 20px; display: flex; gap: 20px;';
          
          const captureBtn = document.createElement('button');
          captureBtn.textContent = 'æ‹ç…§';
          captureBtn.style.cssText = `
            padding: 12px 24px; background: #4F46E5; color: white; 
            border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
          `;
          
          const cancelBtn = document.createElement('button');
          cancelBtn.textContent = 'å–æ¶ˆ';
          cancelBtn.style.cssText = `
            padding: 12px 24px; background: #6B7280; color: white; 
            border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
          `;
          
          controls.appendChild(captureBtn);
          controls.appendChild(cancelBtn);
          modal.appendChild(video);
          modal.appendChild(controls);
          document.body.appendChild(modal);
          
          captureBtn.onclick = () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
              const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
              uploadImageFile(file);
              stream.getTracks().forEach(track => track.stop());
              document.body.removeChild(modal);
            }, 'image/jpeg', 0.8);
          };
          
          cancelBtn.onclick = () => {
            stream.getTracks().forEach(track => track.stop());
            document.body.removeChild(modal);
          };
          
        } catch (error) {
          alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š' + error.message);
        }
      }

      function uploadImageFile(file) {
        // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ å¹¶è§¦å‘ä¸Šä¼ 
        const formData = new FormData();
        formData.append('image', file);
        
        // è·å–æ–‡æœ¬å†…å®¹
        const textArea = document.querySelector('textarea');
        const textContent = textArea ? textArea.value : '';
        if (textContent) {
          formData.append('text_content', textContent);
        }
        
        // å‘é€åˆ°æœåŠ¡å™¨
        fetch('/api/diary/entries', {
          method: 'POST',
          body: formData
        }).then(response => response.json())
        .then(data => {
          if (data.success) {
            // æ¸…ç©ºè¾“å…¥æ¡†
            if (textArea) textArea.value = '';
            // åˆ·æ–°é¡µé¢æˆ–æ›´æ–°æ˜¾ç¤º
            setTimeout(() => location.reload(), 500);
          } else {
            alert('ä¸Šä¼ å¤±è´¥ï¼š' + data.message);
          }
        }).catch(error => {
          alert('ä¸Šä¼ é”™è¯¯ï¼š' + error.message);
        });
      }

      // ç›‘å¬é¡µé¢å˜åŒ–ï¼Œè®¾ç½®å›¾ç‰‡åŠŸèƒ½
      const imageObserver = new MutationObserver(setupImageFeatures);
      imageObserver.observe(document.getElementById('root'), { childList: true, subtree: true });
      setupImageFeatures();
    </script>
  </body>
</html>
