<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ—¥è®° - Liquid Glass</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        :root {
            --font-family-system: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", "Arial", "Noto Sans", "Liberation Sans", sans-serif;
          
            /* Light Mode Palette */
            --bg-color-light: #f0f2f5;
            --bg-image-light: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            --text-color-light: #1d1d1f;
            --text-color-secondary-light: #6e6e73;
            --accent-color-light: #007aff;
            --glass-bg-light: rgba(242, 242, 247, 0.8);
            --glass-border-light: rgba(255, 255, 255, 0.5);
            --shadow-color-light: rgba(0, 0, 0, 0.1);

            /* Dark Mode Palette */
            --bg-color-dark: #121212;
            --bg-image-dark: linear-gradient(120deg, #272B30 0%, #121212 100%);
            --text-color-dark: #f5f5f7;
            --text-color-secondary-dark: #8e8e93;
            --accent-color-dark: #0a84ff;
            --glass-bg-dark: rgba(28, 28, 30, 0.75);
            --glass-border-dark: rgba(60, 60, 60, 0.7);
            --shadow-color-dark: rgba(0, 0, 0, 0.3);

            /* Success/Error Colors */
            --success-color: #34c759;
            --error-color: #ff3b30;
            --warning-color: #ff9500;

            /* Universal Variables */
            --radius-2xl: 1.5rem; 
            --radius-full: 9999px;
            --shadow-sm: 0 2px 4px var(--shadow-color);
            --shadow-md: 0 4px 12px var(--shadow-color);
            --transition-fluid: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        body {
            --bg-color: var(--bg-color-light);
            --bg-image: var(--bg-image-light);
            --text-color: var(--text-color-light);
            --text-color-secondary: var(--text-color-secondary-light);
            --accent-color: var(--accent-color-light);
            --glass-bg: var(--glass-bg-light);
            --glass-border: var(--glass-border-light);
            --shadow-color: var(--shadow-color-light);
            background-color: var(--bg-color);
            background-image: var(--bg-image);
            background-attachment: fixed;
            font-family: var(--font-family-system);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            transition: background 0.3s ease;
            line-height: 1.6;
        }

        body.dark-mode {
            --bg-color: var(--bg-color-dark);
            --bg-image: var(--bg-image-dark);
            --text-color: var(--text-color-dark);
            --text-color-secondary: var(--text-color-secondary-dark);
            --accent-color: var(--accent-color-dark);
            --glass-bg: var(--glass-bg-dark);
            --glass-border: var(--glass-border-dark);
            --shadow-color: var(--shadow-color-dark);
        }

        /* Global Styles */
        *, *::before, *::after { 
            box-sizing: border-box; 
        }

        /* Icon Base */
        .icon { 
            width: 1em; 
            height: 1em; 
            stroke-width: 2; 
            fill: none; 
            stroke: currentColor; 
            transition: transform 0.3s ease; 
        }

        /* Glass Card Component */
        .card { 
            background: var(--glass-bg); 
            backdrop-filter: blur(25px) saturate(180%); 
            -webkit-backdrop-filter: blur(25px) saturate(180%); 
            border-radius: var(--radius-2xl); 
            box-shadow: var(--shadow-md); 
            border: 1.5px solid var(--glass-border); 
            transition: all var(--transition-fluid); 
            padding: 1.5rem; 
            position: relative; 
            z-index: 1;
            /* Enhanced border visibility */
            background-clip: padding-box;
        }
        .card:hover { 
            transform: translateY(-2px) scale(1.005); 
            box-shadow: 0 8px 24px var(--shadow-color); 
            z-index: 10;
            border-color: color-mix(in srgb, var(--glass-border) 70%, var(--accent-color) 30%);
        }

        /* Button Component */
        .btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem;
            padding: 0.75rem 1.25rem; 
            font-size: 1rem; 
            font-weight: 600; 
            text-decoration: none; 
            background-color: var(--accent-color); 
            color: white; 
            border: none; 
            border-radius: var(--radius-2xl); 
            cursor: pointer; 
            transition: all 0.2s ease; 
            box-shadow: var(--shadow-sm); 
            position: relative;
            overflow: hidden;
            z-index: 2;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before {
            left: 100%;
        }
        .btn:hover { 
            transform: translateY(-2px); 
            filter: brightness(1.1); 
            box-shadow: 0 4px 12px var(--shadow-color); 
            z-index: 15;
        }
        .btn:active { 
            transform: translateY(0) scale(0.98); 
        }
        .btn-secondary { 
            background: var(--glass-bg); 
            color: var(--text-color); 
            border: 1px solid var(--glass-border); 
        }
        .btn-destructive { 
            background-color: var(--error-color); 
        }
        .btn-success { 
            background-color: var(--success-color); 
        }
        .btn:disabled { 
            background-color: var(--text-color-secondary); 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
            filter: none; 
            box-shadow: none; 
        }
        .btn-sm { 
            padding: 0.5rem 1rem; 
            font-size: 0.875rem; 
        }
        .btn-lg { 
            padding: 1rem 1.5rem; 
            font-size: 1.125rem; 
        }

        /* Input Components */
        .input-glass { 
            width: 100%; 
            background: var(--glass-bg); 
            backdrop-filter: blur(10px) saturate(150%); 
            border: 1.5px solid var(--glass-border); 
            border-radius: var(--radius-2xl); 
            padding: 0.75rem 1rem; 
            font-size: 1rem; 
            color: var(--text-color); 
            transition: all var(--transition-fluid); 
            resize: vertical;
            position: relative;
            z-index: 1;
            background-clip: padding-box;
        } 
        .input-glass:focus { 
            outline: none; 
            border-color: var(--accent-color); 
            border-width: 2px;
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 30%, transparent); 
            transform: scale(1.02);
            z-index: 5;
        }
        .input-glass::placeholder {
            color: var(--text-color-secondary);
        }

        /* Textarea specific */
        textarea.input-glass { 
            min-height: 120px; 
        }

        /* Form Groups */
        .form-group { 
            margin-bottom: 1.5rem; 
        }
        .form-group label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 0.5rem; 
            color: var(--text-color);
        }

        /* Navbar Component */
        .navbar { 
            position: sticky; 
            top: 1rem; 
            z-index: 100; 
            margin: 1rem 1rem 2rem 1rem; 
            padding: 1rem 1.5rem; 
            background: var(--glass-bg); 
            backdrop-filter: blur(25px) saturate(180%); 
            -webkit-backdrop-filter: blur(25px) saturate(180%); 
            border-radius: var(--radius-2xl); 
            box-shadow: var(--shadow-md), 0 0 0 1px color-mix(in srgb, var(--glass-border) 50%, transparent), 0 0 20px color-mix(in srgb, var(--accent-color) 10%, transparent); 
            border: 2px solid var(--glass-border); 
            transition: all var(--transition-fluid); 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background-clip: padding-box;
            /* Enhanced visual definition without affecting position */
            isolation: isolate;
        }
        .navbar-brand { 
            font-weight: 700; 
            font-size: 1.25rem; 
            display: flex; 
            align-items: center; 
            gap: 0.75rem;
        }
        .navbar-actions { 
            display: flex; 
            gap: 0.75rem; 
        }

        /* Tabs Component */
        .tabs { 
            display: flex; 
            flex-direction: column; 
            gap: 1rem; 
        }
        .tab-list { 
            position: relative; 
            display: flex; 
            background: var(--glass-bg); 
            border-radius: var(--radius-2xl); 
            padding: 0.5rem; 
            border: 1.5px solid var(--glass-border); 
            z-index: 5;
            background-clip: padding-box;
        }
        .tab-btn { 
            flex: 1;
            padding: 0.75rem 1.25rem; 
            cursor: pointer; 
            border: none; 
            background: none; 
            color: var(--text-color-secondary); 
            font-size: 1rem; 
            font-weight: 600; 
            position: relative; 
            transition: all 0.3s ease; 
            border-radius: var(--radius-2xl); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem;
            z-index: 6;
        }
        .tab-btn.active { 
            color: white; 
            background: var(--accent-color); 
            box-shadow: var(--shadow-sm); 
            transform: scale(1.02);
            z-index: 7;
        }
        .tab-content { 
            display: none; 
        }
        .tab-content.active { 
            display: block; 
            animation: fade-in 0.4s ease; 
        }
        @keyframes fade-in { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Badge Component */
        .badge { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0.25rem 0.75rem; 
            border-radius: var(--radius-full); 
            font-size: 0.8rem; 
            font-weight: 600; 
            background-color: var(--accent-color); 
            color: white; 
        }
        .badge-success { background-color: var(--success-color); }
        .badge-error { background-color: var(--error-color); }
        .badge-warning { background-color: var(--warning-color); }
        .badge-secondary { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            color: var(--text-color); 
        }

        /* Avatar Component */
        .avatar { 
            width: 50px; 
            height: 50px; 
            border-radius: var(--radius-full); 
            object-fit: cover; 
            border: 2px solid var(--glass-border); 
        }

        /* Toast Component */
        .toast-container { 
            position: fixed; 
            bottom: 2rem; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 10000; 
            display: flex; 
            flex-direction: column; 
            gap: 0.5rem; 
            pointer-events: none;
        }
        .toast { 
            min-width: 300px; 
            background: var(--glass-bg); 
            backdrop-filter: blur(25px) saturate(180%); 
            -webkit-backdrop-filter: blur(25px) saturate(180%); 
            border-radius: var(--radius-2xl); 
            box-shadow: var(--shadow-md); 
            border: 1.5px solid var(--glass-border); 
            padding: 1rem; 
            animation: toast-in 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); 
            max-width: 400px; 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            pointer-events: auto;
            background-clip: padding-box;
        }
        @keyframes toast-in { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Modal Component */
        .modal-backdrop { 
            position: fixed; 
            inset: 0; 
            z-index: 9998; 
            background-color: rgba(0,0,0,0.3); 
            backdrop-filter: blur(8px); 
            opacity: 0; 
            pointer-events: none; 
            transition: opacity 0.3s ease-out; 
        }
        .modal-backdrop.visible { 
            opacity: 1; 
            pointer-events: auto; 
        }
        .modal-dialog { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            z-index: 9999; 
            width: 90%; 
            max-width: 500px; 
            transform: translate(-50%, -50%) scale(0.95); 
            opacity: 0; 
            pointer-events: none; 
            transition: all 0.3s ease-out; 
        }
        .modal-dialog.visible { 
            transform: translate(-50%, -50%) scale(1); 
            opacity: 1; 
            pointer-events: auto; 
        }

        /* Accordion Component */
        .accordion-item { 
            background: var(--glass-bg); 
            border-radius: var(--radius-2xl); 
            margin-bottom: 0.5rem; 
            overflow: hidden; 
            border: 1px solid var(--glass-border); 
            transition: all var(--transition-fluid);
        }
        .accordion-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
            padding: 1rem; 
            background: none; 
            border: none; 
            font-size: 1rem; 
            font-weight: 600; 
            cursor: pointer; 
            color: var(--text-color); 
            transition: all 0.3s ease;
        }
        .accordion-header:hover {
            background: color-mix(in srgb, var(--accent-color) 10%, transparent);
        }
        .accordion-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.3s ease-out; 
        }
        .accordion-content-inner { 
            padding: 0 1rem 1rem 1rem; 
        }
        .accordion-item.active .accordion-header .icon { 
            transform: rotate(180deg); 
        }

        /* Theme Switcher */
        .theme-switcher { 
            display: inline-flex; 
            background: var(--glass-bg); 
            border-radius: var(--radius-full); 
            padding: 0.25rem; 
            border: 1px solid var(--glass-border); 
        }
        .theme-switcher button { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            width: 36px; 
            height: 36px; 
            background: none; 
            border: none; 
            border-radius: var(--radius-full); 
            cursor: pointer; 
            color: var(--text-color-secondary); 
            transition: all 0.2s ease; 
        }
        .theme-switcher button:not(.active):hover { 
            background-color: color-mix(in srgb, var(--text-color) 10%, transparent); 
        }
        .theme-switcher button.active { 
            background-color: var(--accent-color); 
            color: white; 
            transform: scale(1.05); 
        }

        /* Search Component */
        .search-wrapper { 
            position: relative; 
        }
        .search-icon { 
            position: absolute; 
            left: 1rem; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-color-secondary); 
        }
        .search-input { 
            padding-left: 3rem; 
        }

        /* Spinner Component */
        .spinner { 
            width: 24px; 
            height: 24px; 
            border: 3px solid color-mix(in srgb, var(--glass-bg) 50%, transparent); 
            border-top-color: var(--accent-color); 
            border-radius: var(--radius-full); 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        /* Checkbox Component */
        .checkbox-wrapper { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            cursor: pointer; 
        }
        .checkbox-input { 
            display: none; 
        }
        .checkbox-custom { 
            width: 24px; 
            height: 24px; 
            border: 2px solid var(--text-color-secondary); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: all 0.2s ease-out; 
            flex-shrink: 0; 
            border-radius: 0.6rem; 
        }
        .checkbox-custom .icon { 
            opacity: 0; 
            transform: scale(0.5); 
            transition: all 0.2s ease-out; 
            color: white; 
            stroke-width: 3; 
        }
        .checkbox-input:checked + .checkbox-custom { 
            background-color: var(--accent-color); 
            border-color: var(--accent-color); 
        }
        .checkbox-input:checked + .checkbox-custom .icon { 
            opacity: 1; 
            transform: scale(1); 
        }

        /* Countdown Display */
        .countdown-display { 
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; 
            font-size: 2rem; 
            font-weight: 700; 
            background: linear-gradient(135deg, var(--accent-color), color-mix(in srgb, var(--accent-color) 80%, var(--success-color))); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text; 
        }

        /* Image Component */
        .image-container { 
            display: inline-block; 
            border-radius: var(--radius-2xl); 
            background: var(--glass-bg); 
            overflow: hidden; 
            width: 100%; 
            position: relative; 
            transition: all var(--transition-fluid);
            border: 1.5px solid var(--glass-border);
            background-clip: padding-box;
        }
        .image-container:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
            border-color: color-mix(in srgb, var(--glass-border) 70%, var(--accent-color) 30%);
        }
        .image-container img { 
            width: 100%; 
            height: auto; 
            object-fit: cover; 
            transition: opacity 0.3s ease; 
            display: block;
        }

        /* Loading Animation */
        .loading-dots::after {
            content: '';
            display: inline-block;
            width: 20px;
            text-align: left;
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Utility Classes */
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 0 1rem; 
        }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .text-secondary { color: var(--text-color-secondary); }
        .hidden { display: none; }
        .block { display: block; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .min-h-screen { min-height: 100vh; }
        .space-y-4 > * + * { margin-top: 1rem; }
        .space-y-6 > * + * { margin-top: 1.5rem; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container { 
                padding: 0 0.75rem; 
                max-width: 100%;
            }
            
            .navbar { 
                position: sticky;
                top: 0.75rem;
                margin: 0.75rem 0.75rem 1.5rem 0.75rem; 
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
                z-index: 100;
            }
            
            .navbar-brand {
                font-size: 1.125rem;
            }
            
            .navbar-actions { 
                gap: 0.5rem; 
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .card { 
                padding: 1rem; 
                margin-bottom: 1rem;
            }
            
            .tab-btn { 
                padding: 0.5rem 0.75rem; 
                font-size: 0.875rem; 
                flex: 1;
                min-width: 0;
            }
            
            .modal-dialog { 
                width: 95%; 
                margin: 1rem;
            }
            
            /* Stack buttons on mobile */
            .btn-group-mobile { 
                display: flex; 
                flex-direction: column; 
                gap: 0.75rem; 
            }
            .btn-group-mobile .btn { 
                width: 100%; 
                padding: 0.875rem 1rem;
                font-size: 1rem;
            }
            
            /* Mobile specific improvements */
            .theme-switcher {
                order: -1;
                margin-bottom: 0.5rem;
            }
            
            .countdown-display {
                font-size: 1.5rem;
            }
            
            /* Reduce animations on mobile for better performance */
            .card:hover {
                transform: translateY(-1px) scale(1.002);
            }
            
            .btn:hover {
                transform: translateY(-1px);
            }
            
            .tab-btn.active {
                transform: scale(1.01);
            }
            
            /* Disable hover effects on touch devices */
            @media (hover: none) {
                .card:hover {
                    transform: none;
                    box-shadow: var(--shadow-md);
                }
                
                .btn:hover {
                    transform: none;
                    filter: none;
                }
                
                .input-glass:focus {
                    transform: none;
                }
            }
            
            /* Better spacing for mobile */
            .space-y-4 > * + * { 
                margin-top: 1.25rem; 
            }
            
            .space-y-6 > * + * { 
                margin-top: 1.75rem; 
            }
            
            /* Mobile input improvements */
            .input-glass {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 1rem;
                -webkit-appearance: none;
                -webkit-tap-highlight-color: transparent;
            }
            
            textarea.input-glass {
                min-height: 120px;
                resize: vertical;
            }
            
            /* Mobile button spacing and touch improvements */
            .btn {
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                min-height: 44px; /* iOS touch target size */
            }
            
            .flex.gap-3 {
                gap: 0.75rem;
            }
            
            /* Image containers on mobile */
            .image-container {
                max-width: 100%;
                overflow: hidden;
                -webkit-tap-highlight-color: transparent;
            }
            
            /* Prevent double-tap zoom */
            * {
                touch-action: manipulation;
            }
            
            /* Mobile scrolling improvements */
            body {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior-y: contain;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .navbar {
                position: sticky;
                top: 0.5rem;
                margin: 0.5rem 0.5rem 1rem 0.5rem;
                padding: 0.75rem;
                z-index: 100;
            }
            
            .card {
                padding: 0.875rem;
            }
            
            .btn-group-mobile .btn {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            
            .countdown-display {
                font-size: 1.25rem;
            }
            
            .tab-btn {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
        }

        /* Special Effects */
        .gradient-text {
            background: linear-gradient(135deg, var(--accent-color), color-mix(in srgb, var(--accent-color) 80%, var(--success-color)));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .shimmer {
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Animation Conflict Prevention */
        .card-container {
            position: relative;
            z-index: 1;
            isolation: isolate;
        }
        
        .card-container:hover {
            z-index: 10;
        }
        
        /* Prevent layout shift during animations */
        .entries-list,
        .history-list {
            transform: translateZ(0); /* Create stacking context */
        }
        
        /* Ensure proper stacking for interactive elements */
        .btn, .input-glass, .tab-btn {
            isolation: isolate;
        }
    </style>
</head>
<body id="app-body">
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Modal Backdrop -->
    <div id="modal-backdrop" class="modal-backdrop"></div>

    <!-- Main App Container -->
    <div id="app" class="min-h-screen">
        <!-- Loading State -->
        <div id="loading-screen" class="min-h-screen flex items-center justify-center">
            <div class="card text-center">
                <div class="spinner mb-4" style="margin: 0 auto;"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>

        <!-- Login Form -->
        <div id="login-form" class="min-h-screen flex items-center justify-center p-4 hidden">
            <div class="card" style="width: 100%; max-width: 400px;">
                <div class="text-center mb-6">
                    <svg class="icon" style="width: 4rem; height: 4rem; margin: 0 auto 1rem; color: var(--accent-color);" viewBox="0 0 24 24">
                        <path d="M12 7v14"></path>
                        <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"></path>
                    </svg>
                    <h1 class="text-2xl font-bold mb-2">AIæ—¥è®°</h1>
                    <p class="text-secondary">è¯·è¾“å…¥å¯†ç ä»¥ç»§ç»­ä½¿ç”¨</p>
                </div>
                
                <div class="space-y-4">
                    <div class="form-group">
                        <label for="password-input">å¯†ç </label>
                        <input type="password" id="password-input" class="input-glass" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password">
                    </div>
                    
                    <div id="login-error" class="hidden" style="background: color-mix(in srgb, var(--error-color) 20%, transparent); border: 1px solid var(--error-color); color: var(--error-color); padding: 0.75rem; border-radius: var(--radius-2xl); font-size: 0.875rem;"></div>
                    
                    <button id="login-btn" class="btn w-full">ç™»å½•</button>
                </div>
                
                <div class="mt-6 text-center text-sm text-secondary">
                    é»˜è®¤å¯†ç ï¼š1234
                </div>
            </div>
        </div>

        <!-- Main App Interface -->
        <div id="main-app" class="hidden">
            <!-- Navigation -->
            <nav class="navbar">
                <div class="navbar-brand">
                    <svg class="icon" style="width: 2rem; height: 2rem; color: var(--accent-color);" viewBox="0 0 24 24">
                        <path d="M12 7v14"></path>
                        <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"></path>
                    </svg>
                    AIæ—¥è®°
                </div>
                <div class="navbar-actions">
                    <div class="theme-switcher" id="theme-switcher">
                        <button data-theme="light" aria-label="æµ…è‰²ä¸»é¢˜">
                            <svg class="icon" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="5"></circle>
                                <line x1="12" y1="1" x2="12" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="23"></line>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                <line x1="1" y1="12" x2="3" y2="12"></line>
                                <line x1="21" y1="12" x2="23" y2="12"></line>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                            </svg>
                        </button>
                        <button data-theme="dark" aria-label="æ·±è‰²ä¸»é¢˜">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                            </svg>
                        </button>
                        <button data-theme="system" aria-label="è·Ÿéšç³»ç»Ÿ" class="active">
                            <svg class="icon" viewBox="0 0 24 24">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                <line x1="8" y1="21" x2="16" y2="21"></line>
                                <line x1="12" y1="17" x2="12" y2="21"></line>
                            </svg>
                        </button>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="window.location.reload()">åˆ·æ–°</button>
                    <button class="btn btn-secondary btn-sm" onclick="openSettings()">è®¾ç½®</button>
                    <button class="btn btn-secondary btn-sm" id="logout-btn">ç™»å‡º</button>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="container space-y-6">
                <!-- Tabs -->
                <div class="tabs">
                    <div class="tab-list">
                        <button class="tab-btn active" data-tab="timeline">
                            <svg class="icon" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            æ—¶é—´çº¿
                        </button>
                        <button class="tab-btn" data-tab="history">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M12 7v14"></path>
                                <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"></path>
                            </svg>
                            å†å²æ—¥è®°
                        </button>
                    </div>

                    <!-- Timeline Tab Content -->
                    <div class="tab-content active" id="timeline-content">
                        <!-- Daily Summary Countdown -->
                        <div class="card" style="background: linear-gradient(135deg, color-mix(in srgb, var(--accent-color) 10%, transparent), color-mix(in srgb, var(--success-color) 10%, transparent)); border: 1px solid color-mix(in srgb, var(--accent-color) 30%, transparent);">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold gradient-text">æ¯æ—¥æ€»ç»“</h3>
                                <div class="text-center">
                                    <p class="text-sm text-secondary mb-1">è·ç¦»è‡ªåŠ¨æ€»ç»“è¿˜æœ‰ï¼š</p>
                                    <div id="countdown-display" class="countdown-display">00:00:00</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-secondary mb-1">ç³»ç»Ÿå°†åœ¨æ¯å¤©0ç‚¹è‡ªåŠ¨ç”Ÿæˆå½“æ—¥çš„æ€»ç»“æ—¥è®°</p>
                                    <p class="text-sm text-secondary">ğŸ“ å·²ç”Ÿæˆçš„æ¯æ—¥æ€»ç»“å¯åœ¨"å†å²æ—¥è®°"æ ‡ç­¾é¡µæŸ¥çœ‹</p>
                                </div>
                                <button id="manual-summary-btn" class="btn btn-success">ç°åœ¨æ€»ç»“</button>
                            </div>
                        </div>

                        <!-- Write Entry Area -->
                        <div class="card">
                            <h2 class="text-lg font-semibold mb-4">ä»Šæ—¥è®°å½•</h2>
                            <div class="space-y-4">
                                <div style="position: relative;">
                                    <textarea id="entry-textarea" class="input-glass" placeholder="è®°å½•ä»Šå¤©å‘ç”Ÿçš„äº‹æƒ…..." style="min-height: 150px;"></textarea>
                                    <div style="position: absolute; bottom: 0.5rem; right: 1rem; font-size: 0.75rem; color: var(--text-color-secondary);" id="char-count">0/1000</div>
                                </div>
                                <div class="flex gap-3 btn-group-mobile">
                                    <button id="submit-entry-btn" class="btn">
                                        <span id="submit-text">å‘é€</span>
                                        <div id="submit-spinner" class="spinner hidden" style="width: 1rem; height: 1rem;"></div>
                                    </button>
                                    <button id="camera-btn" class="btn btn-secondary">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>
                                            <circle cx="12" cy="13" r="3"></circle>
                                        </svg>
                                        æ‹ç…§
                                    </button>
                                    <button id="upload-btn" class="btn btn-secondary">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="7 10 12 15 17 10"></polyline>
                                            <line x1="12" x2="12" y1="15" y2="3"></line>
                                        </svg>
                                        ä¸Šä¼ å›¾ç‰‡
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Search and Filter -->
                        <div class="card">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="search-wrapper w-full">
                                    <svg class="search-icon icon" viewBox="0 0 24 24">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <path d="m21 21-4.35-4.35"></path>
                                    </svg>
                                    <input type="text" id="search-input" class="input-glass search-input" placeholder="æœç´¢æ—¥è®°å†…å®¹...">
                                </div>
                                <button id="filter-toggle" class="btn btn-secondary">
                                    <svg class="icon" viewBox="0 0 24 24">
                                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                                    </svg>
                                    ç­›é€‰
                                </button>
                            </div>
                            <div id="filter-panel" class="hidden" style="border-top: 1px solid var(--glass-border); padding-top: 1rem;">
                                <label class="block text-sm font-semibold mb-2">æƒ…ç»ªç­›é€‰</label>
                                <div id="mood-filters" class="flex gap-2" style="flex-wrap: wrap;">
                                    <button class="btn btn-sm btn-secondary mood-filter active" data-mood="">å…¨éƒ¨</button>
                                </div>
                            </div>
                        </div>

                        <!-- Entries List -->
                        <div id="entries-list" class="space-y-4">
                            <!-- Entries will be loaded here -->
                        </div>
                    </div>

                    <!-- History Tab Content -->
                    <div class="tab-content" id="history-content">
                        <div class="card">
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-lg font-semibold">å†å²æ—¥è®°</h2>
                                <label class="checkbox-wrapper">
                                    <input type="checkbox" id="show-mood-toggle" class="checkbox-input" checked>
                                    <span class="checkbox-custom">
                                        <svg class="icon" viewBox="0 0 24 24">
                                            <path d="M20 6L9 17l-5-5"></path>
                                        </svg>
                                    </span>
                                    <span class="text-sm">æ˜¾ç¤ºæƒ…ç»ªæ ‡ç­¾</span>
                                </label>
                            </div>
                            <p class="text-sm text-secondary">æŒ‰æ—¥æœŸæµè§ˆè¿‡å¾€çš„æ—¥è®°è®°å½•ï¼Œç‚¹å‡»å±•å¼€æŸ¥çœ‹è¯¦ç»†å†…å®¹</p>
                        </div>

                        <div id="history-list" class="space-y-4">
                            <!-- History entries will be loaded here -->
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="config-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index:9999; display:none; animation:fadeIn 0.3s;">
        <iframe src="/config.html" style="width:100%; height:100%; border:none; border-radius: var(--radius-2xl); margin: 2rem; width: calc(100% - 4rem); height: calc(100% - 4rem);"></iframe>
        <button onclick="closeSettings()" style="position: absolute; top: 2rem; right: 2rem; background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-color); padding: 0.5rem; border-radius: var(--radius-full); cursor: pointer; backdrop-filter: blur(10px);">
            <svg style="width: 1.5rem; height: 1.5rem;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18"></path>
                <path d="M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <script>
        // Global State
        let appState = {
            currentUser: null,
            entries: [],
            activeTab: 'timeline',
            loading: true,
            newEntryText: '',
            searchQuery: '',
            filterMood: '',
            isSubmitting: false,
            editingEntry: null,
            expandedDays: new Set(),
            countdown: { hours: 0, minutes: 0, seconds: 0 },
            isGeneratingSummary: false,
            showMoodInHistory: true,
            showFilters: false
        };

        // Utility Functions
        function $(id) { return document.getElementById(id); }
        function $$(selector) { return document.querySelectorAll(selector); }

        function showElement(id) { $(id)?.classList.remove('hidden'); }
        function hideElement(id) { $(id)?.classList.add('hidden'); }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) {
                return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (days === 1) {
                return 'æ˜¨å¤© ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            } else if (days < 7) {
                return `${days}å¤©å‰`;
            } else {
                return date.toLocaleDateString('zh-CN', { 
                    month: 'numeric', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        function formatAnalysis(analysis) {
            if (!analysis) return '';
            if (analysis.includes('AIç†è§£ä¸­')) return analysis;
            
            return analysis
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }

        function getTodayDateString() {
            const today = new Date();
            return today.getFullYear() + '-' + 
                   String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(today.getDate()).padStart(2, '0');
        }

        // Toast Notifications
        function showToast(message, type = 'info') {
            const container = $('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            const badgeClass = type === 'success' ? 'badge-success' : 
                              type === 'error' ? 'badge-error' : 'badge';
            
            toast.innerHTML = `
                <span class="badge ${badgeClass}">${type === 'success' ? 'âœ“' : type === 'error' ? '!' : 'i'}</span>
                <p style="margin: 0;">${message}</p>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        // Theme Management
        function initTheme() {
            const themeSwitcher = $('theme-switcher');
            const themeButtons = themeSwitcher.querySelectorAll('button');
            const body = document.body;

            const applyTheme = (theme) => {
                if (theme === 'system') {
                    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    body.classList.toggle('dark-mode', systemPrefersDark);
                } else {
                    body.classList.toggle('dark-mode', theme === 'dark');
                }
            };

            const updateButtonState = (activeTheme) => {
                themeButtons.forEach(button => {
                    button.classList.toggle('active', button.dataset.theme === activeTheme);
                });
            };

            const savedTheme = localStorage.getItem('theme') || 'system';
            applyTheme(savedTheme);
            updateButtonState(savedTheme);

            themeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const newTheme = button.dataset.theme;
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                    updateButtonState(newTheme);
                });
            });

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                const currentTheme = localStorage.getItem('theme');
                if (currentTheme === 'system') {
                    applyTheme('system');
                }
            });
        }

        // Countdown Timer
        function calculateCountdown() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const diff = tomorrow.getTime() - now.getTime();
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            return { hours, minutes, seconds };
        }

        function updateCountdown() {
            const countdown = calculateCountdown();
            const display = $('countdown-display');
            if (display) {
                display.textContent = `${countdown.hours.toString().padStart(2, '0')}:${countdown.minutes.toString().padStart(2, '0')}:${countdown.seconds.toString().padStart(2, '0')}`;
            }
            appState.countdown = countdown;
        }

        // API Functions
        async function fetchUserInfo(timeout = 5000) {
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeout);
            try {
                const response = await fetch('/api/auth/check', {
                    credentials: 'include',
                    signal: controller.signal
                });
                clearTimeout(timer);
                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        appState.currentUser = { authenticated: true };
                        return true;
                    }
                }
                return false;
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€è¶…æ—¶');
                } else {
                    console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                }
                return false;
            }
        }

        async function fetchEntries() {
            try {
                const params = new URLSearchParams();
                
                // Always fetch all entries including daily summaries for both views
                if (appState.activeTab === 'history') {
                    params.append('view', 'history');
                }
                
                params.append('per_page', '100');
                
                const url = `/api/diary/entries?${params.toString()}`;
                const response = await fetch(url, { credentials: 'include' });
                
                if (response.ok) {
                    const data = await response.json();
                    appState.entries = data.entries || [];
                    
                    // Always render both views to ensure data consistency
                    renderEntries();
                    renderHistory();
                } else {
                    console.error('è·å–æ—¥è®°æ¡ç›®å¤±è´¥ï¼ŒçŠ¶æ€ç :', response.status);
                }
            } catch (error) {
                console.error('è·å–æ—¥è®°æ¡ç›®å¼‚å¸¸:', error);
            }
        }

        async function login(password) {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password }),
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    appState.currentUser = { authenticated: true };
                    return { success: true };
                } else {
                    return { success: false, message: data.message || 'ç™»å½•å¤±è´¥' };
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                return { success: false, message: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•' };
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                window.location.reload();
            } catch (error) {
                console.error('ç™»å‡ºå¤±è´¥:', error);
            }
        }

        async function submitEntry(textContent, imageFile = null) {
            const formData = new FormData();
            formData.append('text_content', textContent);
            if (imageFile) {
                formData.append('image', imageFile);
            }

            try {
                const response = await fetch('/api/diary/entries', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                if (response.ok) {
                    appState.newEntryText = '';
                    $('entry-textarea').value = '';
                    updateCharCount();
                    
                    fetchEntries();
                    showToast('æ—¥è®°ä¿å­˜æˆåŠŸï¼', 'success');
                    
                    // Poll for AI analysis completion
                    pollAIAnalysis();
                    return true;
                } else {
                    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    return false;
                }
            } catch (error) {
                console.error('å‘é€æ—¥è®°å¤±è´¥:', error);
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                return false;
            }
        }

        async function pollAIAnalysis() {
            let attempts = 0;
            const maxAttempts = 30;
            
            const pollInterval = setInterval(async () => {
                attempts++;
                try {
                    const response = await fetch('/api/diary/entries?per_page=1', {
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const latestEntry = data.entries[0];
                        
                        if (latestEntry && latestEntry.ai_analysis && !latestEntry.ai_analysis.includes('AIç†è§£ä¸­')) {
                            clearInterval(pollInterval);
                            fetchEntries();
                            showToast('AIç†è§£å®Œæˆï¼', 'success');
                        }
                    }
                    
                    if (attempts >= maxAttempts) {
                        clearInterval(pollInterval);
                    }
                } catch (error) {
                    console.error('è½®è¯¢AIåˆ†æçŠ¶æ€å¤±è´¥:', error);
                }
            }, 1000);
        }

        async function deleteEntry(entryId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ')) return false;

            try {
                const response = await fetch(`/api/diary/entries/${entryId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    appState.entries = appState.entries.filter(entry => entry.id !== entryId);
                    renderEntries();
                    renderHistory();
                    showToast('æ—¥è®°å·²åˆ é™¤', 'success');
                    return true;
                } else {
                    showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    return false;
                }
            } catch (error) {
                console.error('åˆ é™¤æ—¥è®°å¤±è´¥:', error);
                showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                return false;
            }
        }

        async function generateDailySummary() {
            try {
                const response = await fetch('/api/diary/generate-daily-summary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: getTodayDateString() }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showToast('æ¯æ—¥æ€»ç»“ç”ŸæˆæˆåŠŸï¼', 'success');
                    // Re-fetch entries to get the latest data including the summary
                    await fetchEntries();
                    // Switch to history tab to show the new summary
                    switchTab('history');
                    setTimeout(() => {
                        showToast('æ¯æ—¥æ€»ç»“å·²æ·»åŠ åˆ°å†å²æ—¥è®° ğŸ“', 'success');
                    }, 1000);
                    return true;
                } else {
                    const error = await response.json();
                    showToast(error.message || 'ç”Ÿæˆæ€»ç»“å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                    return false;
                }
            } catch (error) {
                console.error('ç”Ÿæˆæ€»ç»“å¤±è´¥:', error);
                showToast('ç”Ÿæˆæ€»ç»“å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                return false;
            }
        }

        // Rendering Functions
        function renderEntries() {
            const container = $('entries-list');
            const filteredEntries = getFilteredEntries();
            
            if (filteredEntries.length === 0) {
                container.innerHTML = `
                    <div class="card text-center">
                        <svg class="icon" style="width: 3rem; height: 3rem; color: var(--text-color-secondary); margin: 0 auto 1rem;" viewBox="0 0 24 24">
                            <path d="M12 7v14"></path>
                            <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"></path>
                        </svg>
                        <p class="text-secondary mb-2">${appState.searchQuery || appState.filterMood ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ—¥è®°' : 'è¿˜æ²¡æœ‰æ—¥è®°æ¡ç›®ï¼Œå¼€å§‹å†™ä¸‹ç¬¬ä¸€ç¯‡å§ï¼'}</p>
                        ${(appState.searchQuery || appState.filterMood) ? '<button class="btn btn-secondary mt-2" onclick="clearFilters()">æ¸…é™¤ç­›é€‰</button>' : ''}
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredEntries.map(entry => `
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2 text-sm text-secondary">
                            <svg class="icon" viewBox="0 0 24 24" style="width: 1rem; height: 1rem;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            ${formatTime(entry.timestamp)}
                        </div>
                        ${!entry.is_daily_summary ? `
                            <div class="flex gap-2" style="flex-shrink: 0;">
                                <button class="btn btn-sm btn-destructive" onclick="deleteEntry('${entry.id}')" title="åˆ é™¤è¿™ç¯‡æ—¥è®°">
                                    <svg class="icon" style="width: 0.875rem; height: 0.875rem;" viewBox="0 0 24 24">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                        <path d="M8 6V4c0-1 1-2 2-2h4c0 1 1 2 1 2v2"></path>
                                        <line x1="10" x2="10" y1="11" y2="17"></line>
                                        <line x1="14" x2="14" y1="11" y2="17"></line>
                                    </svg>
                                    åˆ é™¤
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${entry.text_content ? `<div class="mb-6"><p style="white-space: pre-wrap;">${entry.text_content}</p></div>` : ''}
                    
                    ${entry.image_path ? `
                        <div class="mb-6">
                            <div class="image-container" onclick="window.open('${entry.image_path}', '_blank')" style="cursor: pointer;">
                                <img src="${entry.image_path}" alt="æ—¥è®°å›¾ç‰‡" style="width: 100%; height: auto;">
                            </div>
                        </div>
                    ` : ''}
                    
                    ${entry.ai_analysis ? `
                        <div style="background: color-mix(in srgb, var(--accent-color) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-color) 30%, transparent); border-radius: var(--radius-2xl); padding: 1rem; margin-top: 1rem;">
                            <h4 class="text-sm font-semibold mb-2" style="color: var(--accent-color);">AIç†è§£</h4>
                            <div class="text-sm" style="color: var(--accent-color);">${formatAnalysis(entry.ai_analysis)}</div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderHistory() {
            const container = $('history-list');
            const historyDays = getHistoryEntriesByDate();
            
            const historyArray = Object.entries(historyDays)
                .map(([date, entries]) => ({ date, entries }))
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (historyArray.length === 0) {
                container.innerHTML = `
                    <div class="card text-center">
                        <svg class="icon" style="width: 3rem; height: 3rem; color: var(--text-color-secondary); margin: 0 auto 1rem;" viewBox="0 0 24 24">
                            <path d="M12 7v14"></path>
                            <path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"></path>
                        </svg>
                        <p class="text-secondary">è¿˜æ²¡æœ‰å†å²æ—¥è®°è®°å½•</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = historyArray.map(({ date, entries: dayEntries }) => {
                const isExpanded = appState.expandedDays.has(date);
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });

                return `
                    <div class="card" style="padding: 0; overflow: hidden;">
                        <div class="p-6" style="cursor: pointer; transition: background-color 0.2s ease;" onclick="toggleDayExpansion('${date}')" onmouseover="this.style.background='color-mix(in srgb, var(--accent-color) 5%, transparent)'" onmouseout="this.style.background='transparent'">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-lg font-semibold">${formattedDate}</h3>
                                    <p class="text-sm text-secondary mt-1">${generateDaySummary(dayEntries, date)}</p>
                                </div>
                                <svg class="icon" style="transform: ${isExpanded ? 'rotate(90deg)' : 'rotate(0deg)'}; transition: transform 0.2s ease; color: var(--text-color-secondary);" viewBox="0 0 24 24">
                                    <path d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                        
                        ${isExpanded ? `
                            <div style="border-top: 1px solid var(--glass-border); background: color-mix(in srgb, var(--glass-bg) 50%, transparent); padding: 1rem;">
                                <div class="space-y-4">
                                    ${dayEntries.map(entry => `
                                        <div class="card" style="${entry.is_daily_summary ? 'background: linear-gradient(135deg, color-mix(in srgb, var(--warning-color) 15%, transparent), color-mix(in srgb, var(--success-color) 15%, transparent)); border: 2px solid color-mix(in srgb, var(--warning-color) 40%, transparent);' : ''}">
                                            <div class="flex items-center justify-between mb-4">
                                                <div class="flex items-center gap-2 text-sm text-secondary">
                                                    <svg class="icon" style="width: 1rem; height: 1rem;" viewBox="0 0 24 24">
                                                        ${entry.is_daily_summary ? '<path d="M12 7v14"></path><path d="M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"></path>' : '<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>'}
                                                    </svg>
                                                    ${entry.is_daily_summary ? 'ğŸ“ æ¯æ—¥æ€»ç»“' : formatTime(entry.created_at || entry.timestamp)}
                                                </div>
                                                ${!entry.is_daily_summary ? `
                                                    <div class="flex gap-2" style="flex-shrink: 0;">
                                                        <button class="btn btn-sm btn-destructive" onclick="deleteEntry('${entry.id}')" title="åˆ é™¤è¿™ç¯‡æ—¥è®°">åˆ é™¤</button>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            
                                            ${entry.text_content ? `<div class="mb-6"><p style="white-space: pre-wrap; ${entry.is_daily_summary ? 'font-weight: 500; line-height: 1.7;' : ''}">${entry.text_content}</p></div>` : ''}
                                            
                                            ${entry.image_path ? `
                                                <div class="mb-6">
                                                    <div class="image-container" onclick="window.open('${entry.image_path}', '_blank')" style="cursor: pointer;">
                                                        <img src="${entry.image_path}" alt="æ—¥è®°å›¾ç‰‡" style="width: 100%; height: auto;">
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            ${entry.ai_analysis ? `
                                                <div style="background: color-mix(in srgb, var(--accent-color) 10%, transparent); border: 1px solid color-mix(in srgb, var(--accent-color) 30%, transparent); border-radius: var(--radius-2xl); padding: 1rem; margin-top: 1rem;">
                                                    <h4 class="text-sm font-semibold mb-2" style="color: var(--accent-color);">AIç†è§£</h4>
                                                    <div class="text-sm" style="color: var(--accent-color);">${formatAnalysis(entry.ai_analysis)}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function renderMoodFilters() {
            const container = $('mood-filters');
            const moods = getMoodTags();
            
            const buttons = [
                { mood: '', label: 'å…¨éƒ¨', active: !appState.filterMood },
                ...moods.map(mood => ({ mood, label: mood, active: appState.filterMood === mood }))
            ];
            
            container.innerHTML = buttons.map(({ mood, label, active }) => `
                <button class="btn btn-sm btn-secondary mood-filter ${active ? 'active' : ''}" 
                        data-mood="${mood}" 
                        onclick="setMoodFilter('${mood}')"
                        style="${active ? 'background-color: var(--accent-color); color: white;' : ''}">
                    ${label}
                </button>
            `).join('');
        }

        // Helper Functions
        function getFilteredEntries() {
            return appState.entries.filter(entry => {
                if (entry.is_daily_summary) return false;
                
                let include = true;
                
                if (appState.searchQuery) {
                    const query = appState.searchQuery.toLowerCase();
                    const textMatch = entry.text_content && entry.text_content.toLowerCase().includes(query);
                    const analysisMatch = entry.ai_analysis && entry.ai_analysis.toLowerCase().includes(query);
                    include = include && (textMatch || analysisMatch);
                }
                
                if (appState.filterMood) {
                    include = include && entry.ai_analysis && entry.ai_analysis.toLowerCase().includes(appState.filterMood.toLowerCase());
                }
                
                return include;
            });
        }

        function getHistoryEntriesByDate() {
            const grouped = {};
            
            appState.entries.forEach(entry => {
                // Use multiple possible timestamp fields and prefer created_at for daily summaries
                let entryDate = null;
                
                if (entry.timestamp) {
                    entryDate = entry.timestamp.split('T')[0];
                } else if (entry.created_at) {
                    entryDate = entry.created_at.split('T')[0];
                } else if (entry.date) {
                    entryDate = entry.date;
                }
                
                if (entryDate) {
                    if (!grouped[entryDate]) {
                        grouped[entryDate] = [];
                    }
                    grouped[entryDate].push(entry);
                }
            });
            
            return grouped;
        }

        function generateDaySummary(dayEntries, date) {
            if (dayEntries.length === 0) return '';
            
            // Find daily summary entry first
            const dailySummary = dayEntries.find(entry => entry.is_daily_summary);
            
            if (dailySummary) {
                const summaryText = dailySummary.text_content || dailySummary.ai_analysis || '';
                const preview = summaryText.length > 50 ? summaryText.substring(0, 50) + '...' : summaryText;
                return `âœ… æ¯æ—¥æ€»ç»“å·²ç”Ÿæˆ Â· ${preview}`;
            }
            
            const today = getTodayDateString();
            const regularEntries = dayEntries.filter(entry => !entry.is_daily_summary);
            
            if (regularEntries.length === 0) return '';
            
            const hasAnalyzingEntries = regularEntries.some(e => 
                e.ai_analysis && ['AIç†è§£ä¸­', 'åˆ†æä¸­', 'å¤„ç†ä¸­'].some(keyword => 
                    e.ai_analysis.includes(keyword)
                )
            );
            
            if (date === today) {
                if (hasAnalyzingEntries) {
                    return `${regularEntries.length}æ¡è®°å½• Â· AIåˆ†æä¸­ï¼Œå‡†å¤‡ç”Ÿæˆæ€»ç»“...`;
                }
                return `${regularEntries.length}æ¡è®°å½• Â· å¯ä»¥æ‰‹åŠ¨ç”Ÿæˆæ¯æ—¥æ€»ç»“`;
            } else {
                const allText = regularEntries
                    .map(entry => entry.text_content || '')
                    .filter(text => text.trim())
                    .join(' ');
                
                const aiAnalyses = regularEntries
                    .map(entry => entry.ai_analysis || '')
                    .filter(analysis => analysis && !analysis.includes('AIç†è§£ä¸­'));
                
                if (appState.showMoodInHistory && aiAnalyses.length > 0) {
                    const combinedAnalysis = aiAnalyses.join(' ');
                    const moodMatches = combinedAnalysis.match(/(å¼€å¿ƒ|å¿«ä¹|é«˜å…´|æ„‰å¿«|å…´å¥‹|æ»¡è¶³|å¹¸ç¦|å–œæ‚¦|ä¹è§‚|è½»æ¾|å¹³é™|å®‰é™|æ”¾æ¾|æ‚ é—²|èˆ’é€‚|å®é™|æ²®ä¸§|éš¾è¿‡|ä¼¤å¿ƒ|å¿§éƒ|å¤±è½|å­¤ç‹¬|æ„¤æ€’|ç”Ÿæ°”|çƒ¦èº|ç„¦è™‘|ç´§å¼ |æ‹…å¿ƒ|å‹åŠ›|ç–²æƒ«|ç´¯|æ— èŠ|æ€è€ƒ|åæ€|æ„ŸåŠ¨|æ¸©æš–|æ„Ÿæ¿€|æƒŠå–œ|æœŸå¾…|å¸Œæœ›)/g);
                    
                    if (moodMatches && moodMatches.length > 0) {
                        const uniqueMoods = [...new Set(moodMatches)];
                        return `${regularEntries.length}æ¡è®°å½• Â· ${uniqueMoods.slice(0, 3).join('ã€')}çš„ä¸€å¤©`;
                    }
                }
                
                const count = regularEntries.length;
                return `${count}æ¡è®°å½• Â· ${allText.length > 25 ? allText.substring(0, 25) + '...' : allText || 'è®°å½•ç”Ÿæ´»ç‚¹æ»´'}`;
            }
        }

        function getMoodTags() {
            const moods = new Set();
            appState.entries.forEach(entry => {
                if (entry.ai_analysis) {
                    const moodMatches = entry.ai_analysis.match(/(å¼€å¿ƒ|å¿«ä¹|é«˜å…´|æ„‰å¿«|å…´å¥‹|æ»¡è¶³|å¹¸ç¦|å–œæ‚¦|ä¹è§‚|è½»æ¾|å¹³é™|å®‰é™|æ”¾æ¾|æ‚ é—²|èˆ’é€‚|å®é™|æ²®ä¸§|éš¾è¿‡|ä¼¤å¿ƒ|å¿§éƒ|å¤±è½|å­¤ç‹¬|æ„¤æ€’|ç”Ÿæ°”|çƒ¦èº|ç„¦è™‘|ç´§å¼ |æ‹…å¿ƒ|å‹åŠ›|ç–²æƒ«|ç´¯|æ— èŠ|æ€è€ƒ|åæ€|æ„ŸåŠ¨|æ¸©æš–|æ„Ÿæ¿€|æƒŠå–œ|æœŸå¾…|å¸Œæœ›|å›°æƒ‘|ç–‘æƒ‘|å¥½å¥‡)/g);
                    if (moodMatches) {
                        moodMatches.forEach(mood => moods.add(mood));
                    }
                }
            });
            return Array.from(moods);
        }

        function updateCharCount() {
            const textarea = $('entry-textarea');
            const counter = $('char-count');
            const length = textarea.value.length;
            counter.textContent = `${length}/1000`;
            
            if (length > 1000) {
                counter.style.color = 'var(--error-color)';
            } else if (length > 800) {
                counter.style.color = 'var(--warning-color)';
            } else {
                counter.style.color = 'var(--text-color-secondary)';
            }
        }

        // Event Handlers
        function switchTab(tabName) {
            appState.activeTab = tabName;
            
            $$('.tab-btn').forEach(btn => btn.classList.remove('active'));
            $$('.tab-content').forEach(content => content.classList.remove('active'));
            
            $(tabName + '-content').classList.add('active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Re-fetch entries when switching tabs to ensure fresh data
            fetchEntries().then(() => {
                if (tabName === 'history') {
                    renderHistory();
                } else {
                    renderEntries();
                    renderMoodFilters();
                }
            });
        }

        function toggleDayExpansion(date) {
            if (appState.expandedDays.has(date)) {
                appState.expandedDays.delete(date);
            } else {
                appState.expandedDays.add(date);
            }
            renderHistory();
        }

        function setMoodFilter(mood) {
            appState.filterMood = mood;
            renderEntries();
            renderMoodFilters();
        }

        function clearFilters() {
            appState.searchQuery = '';
            appState.filterMood = '';
            $('search-input').value = '';
            renderEntries();
            renderMoodFilters();
        }

        async function handleCameraCapture() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showToast('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼šæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½', 'error');
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }
                });
                
                // Create camera interface
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.9); z-index: 10000; display: flex; 
                    flex-direction: column; align-items: center; justify-content: center;
                `;
                
                const video = document.createElement('video');
                video.style.cssText = 'max-width: 90%; max-height: 70%; border-radius: var(--radius-2xl);';
                video.srcObject = stream;
                video.autoplay = true;
                video.playsInline = true;
                
                const controls = document.createElement('div');
                controls.style.cssText = 'margin-top: 20px; display: flex; gap: 20px;';
                
                const captureBtn = document.createElement('button');
                captureBtn.textContent = 'æ‹ç…§';
                captureBtn.className = 'btn';
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'å–æ¶ˆ';
                cancelBtn.className = 'btn btn-secondary';
                
                controls.appendChild(captureBtn);
                controls.appendChild(cancelBtn);
                modal.appendChild(video);
                modal.appendChild(controls);
                document.body.appendChild(modal);
                
                captureBtn.onclick = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    
                    canvas.toBlob(blob => {
                        const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
                        handleImageUpload(file);
                        stream.getTracks().forEach(track => track.stop());
                        document.body.removeChild(modal);
                    }, 'image/jpeg', 0.8);
                };
                
                cancelBtn.onclick = () => {
                    stream.getTracks().forEach(track => track.stop());
                    document.body.removeChild(modal);
                };
                
            } catch (error) {
                showToast('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š' + error.message, 'error');
            }
        }

        function handleFileSelect() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            };
            input.click();
        }

        async function handleImageUpload(file) {
            if (appState.isSubmitting) return;
            
            const textContent = $('entry-textarea').value;
            appState.isSubmitting = true;
            updateSubmitButton();
            
            const success = await submitEntry(textContent, file);
            appState.isSubmitting = false;
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const btn = $('submit-entry-btn');
            const text = $('submit-text');
            const spinner = $('submit-spinner');
            
            if (appState.isSubmitting) {
                text.textContent = 'å‘é€ä¸­';
                spinner.classList.remove('hidden');
                btn.disabled = true;
            } else {
                text.textContent = 'å‘é€';
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }

        // Settings Functions
        function openSettings() {
            $('config-overlay').style.display = 'block';
        }

        function closeSettings() {
            $('config-overlay').style.display = 'none';
        }

        // Make functions global for onclick handlers
        window.openSettings = openSettings;
        window.closeSettings = closeSettings;
        window.switchTab = switchTab;
        window.toggleDayExpansion = toggleDayExpansion;
        window.setMoodFilter = setMoodFilter;
        window.clearFilters = clearFilters;
        window.deleteEntry = deleteEntry;

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();

            // Start countdown timer
            updateCountdown();
            setInterval(updateCountdown, 1000);

            const passwordInput = $('password-input');
            const loginBtn = $('login-btn');
            const loginError = $('login-error');

            const initializeMainApp = async () => {
                showElement('main-app');
                await fetchEntries();
                renderMoodFilters();

                // Main app event listeners
                $$('.tab-btn').forEach(btn => {
                    btn.onclick = () => switchTab(btn.dataset.tab);
                });

                $('entry-textarea').oninput = (e) => {
                    appState.newEntryText = e.target.value;
                    updateCharCount();
                };

                $('submit-entry-btn').onclick = async () => {
                    if (appState.isSubmitting || !appState.newEntryText.trim()) return;

                    appState.isSubmitting = true;
                    updateSubmitButton();

                    const success = await submitEntry(appState.newEntryText);
                    appState.isSubmitting = false;
                    updateSubmitButton();
                };

                $('camera-btn').onclick = handleCameraCapture;
                $('upload-btn').onclick = handleFileSelect;

                $('search-input').oninput = (e) => {
                    appState.searchQuery = e.target.value;
                    renderEntries();
                };

                $('filter-toggle').onclick = () => {
                    appState.showFilters = !appState.showFilters;
                    if (appState.showFilters) {
                        showElement('filter-panel');
                        $('filter-toggle').style.backgroundColor = 'color-mix(in srgb, var(--accent-color) 20%, transparent)';
                    } else {
                        hideElement('filter-panel');
                        $('filter-toggle').style.backgroundColor = '';
                    }
                };

                $('show-mood-toggle').onchange = (e) => {
                    appState.showMoodInHistory = e.target.checked;
                    renderHistory();
                };

                $('manual-summary-btn').onclick = async () => {
                    if (appState.isGeneratingSummary) return;

                    appState.isGeneratingSummary = true;
                    $('manual-summary-btn').innerHTML = '<div class="spinner" style="width: 1rem; height: 1rem;"></div> ç”Ÿæˆä¸­...';
                    $('manual-summary-btn').disabled = true;

                    await generateDailySummary();

                    appState.isGeneratingSummary = false;
                    $('manual-summary-btn').innerHTML = 'ç°åœ¨æ€»ç»“';
                    $('manual-summary-btn').disabled = false;
                };

                $('logout-btn').onclick = logout;

                updateCharCount();
            };

            const handleLogin = async () => {
                const password = passwordInput.value.trim();
                if (!password) {
                    loginError.textContent = 'è¯·è¾“å…¥å¯†ç ';
                    showElement('login-error');
                    return;
                }

                loginBtn.disabled = true;
                loginBtn.innerHTML = '<div class="spinner" style="width: 1rem; height: 1rem;"></div> ç™»å½•ä¸­...';

                const result = await login(password);

                if (result.success) {
                    hideElement('login-form');
                    await initializeMainApp();
                } else {
                    loginError.textContent = result.message;
                    showElement('login-error');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'ç™»å½•';
                }
            };

            loginBtn.onclick = handleLogin;
            passwordInput.onkeypress = (e) => e.key === 'Enter' && handleLogin();

            fetchUserInfo().then(async (isAuthenticated) => {
                appState.loading = false;

                hideElement('loading-screen');

                if (!isAuthenticated) {
                    showElement('login-form');
                } else {
                    hideElement('login-form');
                    await initializeMainApp();
                }
            });
        });
    </script>
</body>
</html>
