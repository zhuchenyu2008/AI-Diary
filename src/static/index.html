<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIæ—¥è®°</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module" crossorigin src="/assets/index-DUaNkWBt.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-oWMHbS2h.css">
  <style>
    #config-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.95);z-index:9999;display:none;animation:fadeIn 0.3s;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    #button-container{display:flex;gap:0.5rem;margin-left:auto;}
    @media(max-width:640px){#button-container{padding-right:0.5rem;}}
  </style>
  </head>
  <body>
    <div id="root"></div>
    <div id="config-overlay">
      <iframe src="/config.html" style="width:100%;height:100%;border:none;"></iframe>
    </div>
    <script>
      function openSettings(){document.getElementById('config-overlay').style.display='block';}
      function closeSettings(){document.getElementById('config-overlay').style.display='none';}
      function addSettingsButton(){
        const logoutBtn=[...document.querySelectorAll('button')].find(b=>b.textContent.trim()==='ç™»å‡º');
        if(!logoutBtn) return;
        let wrapper=document.getElementById('button-container');
        if(!wrapper){
          wrapper=document.createElement('div');
          wrapper.id='button-container';
          logoutBtn.parentNode.insertBefore(wrapper,logoutBtn);
        }
        if(logoutBtn.parentNode!==wrapper){
          wrapper.appendChild(logoutBtn);
        }
        let settingBtn=document.getElementById('settings-button');
        if(!settingBtn){
          settingBtn=logoutBtn.cloneNode(true);
          settingBtn.id='settings-button';
          settingBtn.textContent='è®¾ç½®';
          settingBtn.addEventListener('click',openSettings);
        }
        if(settingBtn.parentNode!==wrapper){
          wrapper.appendChild(settingBtn);
        }
      }
      const ob=new MutationObserver(addSettingsButton);
      ob.observe(document.getElementById('root'),{childList:true,subtree:true});
      addSettingsButton();

      function renderMarkdown() {
        const analysisElements = document.querySelectorAll('.ai-analysis-content');
        analysisElements.forEach(el => {
          if (!el.dataset.rendered) {
            el.innerHTML = marked.parse(el.textContent || '');
            el.dataset.rendered = 'true';
          }
        });
      }

      const markdownObserver = new MutationObserver(renderMarkdown);
      markdownObserver.observe(document.getElementById('root'), { childList: true, subtree: true });
      renderMarkdown();

      // å®æ—¶AIåˆ†æçŠ¶æ€æ£€æŸ¥
      let analysisCheckInterval = null;
      
      function startAnalysisStatusCheck() {
        if (analysisCheckInterval) {
          clearInterval(analysisCheckInterval);
        }
        
        analysisCheckInterval = setInterval(async () => {
          try {
            const response = await fetch('/api/diary/entries/today/analysis-status');
            if (response.ok) {
              const data = await response.json();
              if (data.success) {
                let hasAnalyzing = false;
                data.entries.forEach(entry => {
                  if (entry.is_analyzing) {
                    hasAnalyzing = true;
                  }
                  // æ›´æ–°é¡µé¢ä¸­å¯¹åº”æ¡ç›®çš„AIåˆ†æå†…å®¹
                  updateEntryAnalysis(entry.id, entry.ai_analysis, entry.is_analyzing);
                });
                
                // å¦‚æœæ²¡æœ‰æ­£åœ¨åˆ†æçš„æ¡ç›®ï¼Œåœæ­¢æ£€æŸ¥
                if (!hasAnalyzing) {
                  clearInterval(analysisCheckInterval);
                  analysisCheckInterval = null;
                }
              }
            }
          } catch (error) {
            console.error('æ£€æŸ¥AIåˆ†æçŠ¶æ€å¤±è´¥:', error);
          }
        }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
      }
      
      function updateEntryAnalysis(entryId, analysis, isAnalyzing) {
        // æŸ¥æ‰¾é¡µé¢ä¸­å¯¹åº”çš„AIåˆ†æå…ƒç´ å¹¶æ›´æ–°
        const analysisElements = document.querySelectorAll(`[data-entry-id="${entryId}"] .ai-analysis-content`);
        analysisElements.forEach(el => {
          if (el.textContent !== analysis) {
            el.textContent = analysis || '';
            el.dataset.rendered = 'false'; // é‡æ–°æ¸²æŸ“markdown
            renderMarkdown();
          }
        });
      }
      
      // ç›‘å¬å‘é€æŒ‰é’®ç‚¹å‡»ï¼Œå¼€å§‹çŠ¶æ€æ£€æŸ¥
      document.addEventListener('click', (e) => {
        if (e.target.textContent && e.target.textContent.includes('å‘é€')) {
          setTimeout(() => {
            startAnalysisStatusCheck();
          }, 1000);
        }
      });

      // å›¾ç‰‡åŠŸèƒ½å¢å¼º
      function setupImageFeatures() {
        // æŸ¥æ‰¾æ·»åŠ å›¾ç‰‡æŒ‰é’®å¹¶æ›¿æ¢ä¸ºä¸¤ä¸ªæŒ‰é’®
        const addImageBtn = document.querySelector('button:has(svg), button[class*="pink"]') ||
                           [...document.querySelectorAll('button')].find(btn => btn.textContent.includes('æ·»åŠ å›¾ç‰‡'));
        
        if (addImageBtn && !document.getElementById('camera-btn')) {
          const container = addImageBtn.parentNode;
          
          // åˆ›å»ºæ‹ç…§æŒ‰é’®
          const cameraBtn = addImageBtn.cloneNode(true);
          cameraBtn.id = 'camera-btn';
          cameraBtn.innerHTML = 'ğŸ“· æ‹ç…§';
          cameraBtn.onclick = openCamera;
          
          // ä¿®æ”¹åŸæŒ‰é’®ä¸ºä¸Šä¼ å›¾ç‰‡
          addImageBtn.innerHTML = 'ğŸ–¼ï¸ ä¸Šä¼ å›¾ç‰‡';
          addImageBtn.id = 'upload-btn';
          
          // æ’å…¥æ‹ç…§æŒ‰é’®
          container.insertBefore(cameraBtn, addImageBtn);
        }
      }

      async function openCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' } // ä¼˜å…ˆä½¿ç”¨åç½®æ‘„åƒå¤´
          });
          
          // åˆ›å»ºæ‹ç…§ç•Œé¢
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 10000; display: flex; 
            flex-direction: column; align-items: center; justify-content: center;
          `;
          
          const video = document.createElement('video');
          video.style.cssText = 'max-width: 90%; max-height: 70%; border-radius: 8px;';
          video.srcObject = stream;
          video.autoplay = true;
          video.playsInline = true;
          
          const controls = document.createElement('div');
          controls.style.cssText = 'margin-top: 20px; display: flex; gap: 20px;';
          
          const captureBtn = document.createElement('button');
          captureBtn.textContent = 'æ‹ç…§';
          captureBtn.style.cssText = `
            padding: 12px 24px; background: #4F46E5; color: white; 
            border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
          `;
          
          const cancelBtn = document.createElement('button');
          cancelBtn.textContent = 'å–æ¶ˆ';
          cancelBtn.style.cssText = `
            padding: 12px 24px; background: #6B7280; color: white; 
            border: none; border-radius: 8px; font-size: 16px; cursor: pointer;
          `;
          
          controls.appendChild(captureBtn);
          controls.appendChild(cancelBtn);
          modal.appendChild(video);
          modal.appendChild(controls);
          document.body.appendChild(modal);
          
          captureBtn.onclick = () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
              const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
              uploadImageFile(file);
              stream.getTracks().forEach(track => track.stop());
              document.body.removeChild(modal);
            }, 'image/jpeg', 0.8);
          };
          
          cancelBtn.onclick = () => {
            stream.getTracks().forEach(track => track.stop());
            document.body.removeChild(modal);
          };
          
        } catch (error) {
          alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼š' + error.message);
        }
      }

      function uploadImageFile(file) {
        // åˆ›å»ºæ–‡ä»¶è¾“å…¥å…ƒç´ å¹¶è§¦å‘ä¸Šä¼ 
        const formData = new FormData();
        formData.append('image', file);
        
        // è·å–æ–‡æœ¬å†…å®¹
        const textArea = document.querySelector('textarea');
        const textContent = textArea ? textArea.value : '';
        if (textContent) {
          formData.append('text_content', textContent);
        }
        
        // å‘é€åˆ°æœåŠ¡å™¨
        fetch('/api/diary/entries', {
          method: 'POST',
          body: formData
        }).then(response => response.json())
        .then(data => {
          if (data.success) {
            // æ¸…ç©ºè¾“å…¥æ¡†
            if (textArea) textArea.value = '';
            // åˆ·æ–°é¡µé¢æˆ–æ›´æ–°æ˜¾ç¤º
            setTimeout(() => location.reload(), 500);
          } else {
            alert('ä¸Šä¼ å¤±è´¥ï¼š' + data.message);
          }
        }).catch(error => {
          alert('ä¸Šä¼ é”™è¯¯ï¼š' + error.message);
        });
      }

      // ç›‘å¬é¡µé¢å˜åŒ–ï¼Œè®¾ç½®å›¾ç‰‡åŠŸèƒ½
      const imageObserver = new MutationObserver(setupImageFeatures);
      imageObserver.observe(document.getElementById('root'), { childList: true, subtree: true });
      setupImageFeatures();
    </script>
  </body>
</html>
