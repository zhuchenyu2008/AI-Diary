<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置设置</title>
    <link rel="stylesheet" href="/assets/index-oWMHbS2h.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }
        .toast {
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
<div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
    <div id="login-section" class="hidden">
        <div class="bg-white p-8 rounded-xl shadow-md max-w-md mx-auto mt-16 animate-fade-in">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">登录</h2>
            <div class="space-y-4">
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">密码</label>
                    <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button onclick="login()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                    登录
                </button>
                <p id="login-msg" class="text-red-500 text-sm text-center min-h-[20px]"></p>
            </div>
        </div>
    </div>

    <div id="config-section" class="hidden animate-fade-in">
        <header class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-gray-900">系统配置</h1>
            <button onclick="goBack()" class="text-sm font-medium text-indigo-600 hover:text-indigo-500 transition-colors">
                返回
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                <h3 class="text-xl font-semibold text-gray-900 border-b pb-3">AI 设置</h3>
                <div>
                    <label for="ai_api_url" class="block text-sm font-medium text-gray-700">AI API 地址</label>
                    <input type="text" id="ai_api_url" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="ai_api_key" class="block text-sm font-medium text-gray-700">AI API 密钥</label>
                    <input type="text" id="ai_api_key" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="ai_model" class="block text-sm font-medium text-gray-700">AI 模型</label>
                    <input type="text" id="ai_model" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="ai_prompt_template" class="block text-sm font-medium text-gray-700">AI 提示词模板</label>
                    <textarea id="ai_prompt_template" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="ai_summary_prompt" class="block text-sm font-medium text-gray-700">AI 每日总结提示词</label>
                    <textarea id="ai_summary_prompt" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                <h3 class="text-xl font-semibold text-gray-900 border-b pb-3">Telegram 设置</h3>
                <div>
                    <label for="telegram_bot_token" class="block text-sm font-medium text-gray-700">Telegram Bot Token</label>
                    <input type="text" id="telegram_bot_token" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="telegram_chat_id" class="block text-sm font-medium text-gray-700">Telegram Chat ID</label>
                    <input type="text" id="telegram_chat_id" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="flex items-center pt-2">
                    <input type="checkbox" id="telegram_enabled" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="telegram_enabled" class="ml-2 block text-sm text-gray-900">启用 Telegram 推送</label>
                </div>
            </div>
        </div>

        <footer class="mt-8 flex items-center justify-end space-x-3">
            <button onclick="testAI()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">测试 AI</button>
            <button onclick="testTelegram()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">测试 Telegram</button>
            <button onclick="saveConfig()" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">保存配置</button>
        </footer>
    </div>
    <div id="toast-container" class="fixed bottom-5 right-5 space-y-2"></div>
</div>
<script>
async function checkAuth() {
    const loginSection = document.getElementById('login-section');
    const configSection = document.getElementById('config-section');
    const res = await fetch('/api/auth/check', { credentials: 'include' });
    const data = await res.json();
    if (data.authenticated) {
        loginSection.classList.add('hidden');
        configSection.classList.remove('hidden');
        loadConfig();
    } else {
        loginSection.classList.remove('hidden');
        configSection.classList.add('hidden');
    }
}
function showToast(message, isSuccess = true) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast p-4 rounded-lg shadow-lg text-white ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

async function login() {
    const msgEl = document.getElementById('login-msg');
    const password = document.getElementById('password').value;
    msgEl.textContent = '';
    const button = event.target;
    button.disabled = true;

    try {
        const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ password })
        });
        const data = await res.json();
        if (res.ok && data.success) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('config-section').classList.remove('hidden');
            loadConfig();
        } else {
            msgEl.textContent = data.message || '登录失败';
        }
    } catch (error) {
        msgEl.textContent = `发生错误: ${error.message}`;
    } finally {
        button.disabled = false;
    }
}

async function loadConfig() {
    try {
        const res = await fetch('/api/configs', { credentials: 'include' });
        if (!res.ok) throw new Error(`无法加载配置: ${res.statusText}`);
        const data = await res.json();
        if (data.success) {
            const map = {};
            data.configs.forEach(c => map[c.key] = c.value);
            document.getElementById('ai_api_url').value = map['ai_api_url'] || '';
            document.getElementById('ai_api_key').value = map['ai_api_key'] || '';
            document.getElementById('ai_model').value = map['ai_model'] || '';
            document.getElementById('ai_prompt_template').value = map['ai_prompt_template'] || '';
            document.getElementById('ai_summary_prompt').value = map['ai_summary_prompt'] || '';
            document.getElementById('telegram_bot_token').value = map['telegram_bot_token'] || '';
            document.getElementById('telegram_chat_id').value = map['telegram_chat_id'] || '';
            document.getElementById('telegram_enabled').checked = map['telegram_enabled'] === 'true';
        } else {
            throw new Error(data.message || '加载配置失败');
        }
    } catch (error) {
        showToast(error.message, false);
    }
}

const loadingIcon = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
  </svg>`;

async function saveConfig() {
    const button = event.target;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `${loadingIcon} 正在保存...`;

    try {
        const configs = [
            { key: 'ai_api_url', value: document.getElementById('ai_api_url').value },
            { key: 'ai_api_key', value: document.getElementById('ai_api_key').value },
            { key: 'ai_model', value: document.getElementById('ai_model').value },
            { key: 'ai_prompt_template', value: document.getElementById('ai_prompt_template').value },
            { key: 'ai_summary_prompt', value: document.getElementById('ai_summary_prompt').value },
            { key: 'telegram_bot_token', value: document.getElementById('telegram_bot_token').value },
            { key: 'telegram_chat_id', value: document.getElementById('telegram_chat_id').value },
            { key: 'telegram_enabled', value: document.getElementById('telegram_enabled').checked ? 'true' : 'false' }
        ];
        const res = await fetch('/api/configs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(configs)
        });
        const data = await res.json();
        if (data.success) {
            showToast('配置已成功保存！');
        } else {
            showToast(`保存失败: ${data.message}`, false);
        }
    } catch (error) {
        showToast(`发生错误: ${error.message}`, false);
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

async function testAI() {
    const button = event.target;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `${loadingIcon.replace('text-white', 'text-gray-700')} 正在测试...`;
    showToast('正在测试 AI 连接...');

    try {
        const res = await fetch('/api/admin/test-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ text: '连接测试' })
        });
        const data = await res.json();
        if (res.ok && data.success) {
            showToast(`AI 测试成功: ${data.message || data.result}`);
        } else {
            showToast(`AI 测试失败: ${data.message || '未知错误'}`, false);
        }
    } catch (error) {
        showToast(`发生错误: ${error.message}`, false);
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

async function testTelegram() {
    const button = event.target;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `${loadingIcon.replace('text-white', 'text-gray-700')} 正在测试...`;
    showToast('正在测试 Telegram 连接...');

    try {
        const res = await fetch('/api/admin/test-telegram', { method: 'POST', credentials: 'include' });
        const data = await res.json();
        if (res.ok && data.success) {
            showToast(`Telegram 测试成功: ${data.message}`);
        } else {
            showToast(`Telegram 测试失败: ${data.message || '未知错误'}`, false);
        }
    } catch (error) {
        showToast(`发生错误: ${error.message}`, false);
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}
function goBack(){
    if (window.parent && window.parent.closeSettings) {
        window.parent.closeSettings();
    } else {
        window.location.href = '/';
    }
}
checkAuth();
</script>
</body>
</html>
