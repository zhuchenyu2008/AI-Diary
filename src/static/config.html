<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置设置</title>
    <!-- Load Tailwind CSS from CDN to ensure utility classes are available -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        .animate-fade-out {
            animation: fadeOut 0.3s ease-in-out;
        }
        .toast {
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* 移动端优化 */
        @media (max-width: 768px) {
            .container {
                padding: 1rem !important;
                max-width: 100% !important;
            }
            
            .grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .bg-white {
                padding: 1rem !important;
                border-radius: 0.75rem !important;
            }
            
            h1 {
                font-size: 1.5rem !important;
                text-align: center !important;
            }
            
            h3 {
                font-size: 1.125rem !important;
            }
            
            .header {
                flex-direction: column !important;
                gap: 1rem !important;
                text-align: center !important;
            }
            
            input, textarea, select {
                font-size: 16px !important; /* 防止iOS缩放 */
                padding: 0.75rem !important;
            }
            
            button {
                min-height: 44px !important;
                padding: 0.75rem 1rem !important;
                font-size: 0.875rem !important;
            }
            
            .space-y-4 > * + * {
                margin-top: 1rem !important;
            }
            
            .grid-cols-1 {
                gap: 1rem !important;
            }
            
            .md\\:grid-cols-2 {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            .container {
                padding: 0.75rem !important;
            }
            
            .bg-white {
                padding: 0.75rem !important;
            }
            
            h1 {
                font-size: 1.25rem !important;
            }
            
            input, textarea {
                padding: 0.625rem !important;
            }
            
            button {
                padding: 0.625rem 0.75rem !important;
                font-size: 0.8rem !important;
            }
        }
        
        /* 确保触摸友好 */
        @media (max-width: 768px) {
            button, 
            input[type="button"], 
            input[type="submit"],
            a.btn {
                min-height: 44px !important;
                min-width: 44px !important;
            }
            
            input[type="checkbox"] {
                min-height: 20px !important;
                min-width: 20px !important;
                transform: scale(1.2) !important;
            }
            
            label {
                font-size: 0.875rem !important;
                line-height: 1.4 !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
<div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
    <div id="config-section" class="animate-fade-in">
        <header class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold text-gray-900">系统配置</h1>
            <button onclick="goBack()" class="text-sm font-medium text-indigo-600 hover:text-indigo-500 transition-colors">
                返回
            </button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                <h3 class="text-xl font-semibold text-gray-900 border-b pb-3">AI 设置</h3>
                <div>
                    <label for="ai_api_url" class="block text-sm font-medium text-gray-700">AI API 地址</label>
                    <input type="text" id="ai_api_url" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="ai_api_key" class="block text-sm font-medium text-gray-700">AI API 密钥</label>
                    <input type="text" id="ai_api_key" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="ai_model" class="block text-sm font-medium text-gray-700">AI 模型</label>
                    <input type="text" id="ai_model" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="ai_prompt_template" class="block text-sm font-medium text-gray-700">AI 提示词模板</label>
                    <textarea id="ai_prompt_template" rows="15" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="ai_summary_prompt" class="block text-sm font-medium text-gray-700">AI 每日总结提示词</label>
                    <textarea id="ai_summary_prompt" rows="10" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                <h3 class="text-xl font-semibold text-gray-900 border-b pb-3">Telegram 设置</h3>
                <div>
                    <label for="telegram_bot_token" class="block text-sm font-medium text-gray-700">Telegram Bot Token</label>
                    <input type="text" id="telegram_bot_token" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="telegram_chat_id" class="block text-sm font-medium text-gray-700">Telegram Chat ID</label>
                    <input type="text" id="telegram_chat_id" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="flex items-center pt-2">
                    <input type="checkbox" id="telegram_enabled" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="telegram_enabled" class="ml-2 block text-sm text-gray-900">启用 Telegram 推送</label>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md space-y-4">
                <h3 class="text-xl font-semibold text-gray-900 border-b pb-3">MCP 记忆管理</h3>
                <div class="text-sm text-gray-600 mb-4">
                    <p>Model Context Protocol (MCP) 让AI能够访问外部工具和数据源，管理用户记忆和个性化分析。</p>
                </div>
                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg border border-indigo-100">
                    <div>
                        <h4 class="font-medium text-gray-900">MCP 管理中心</h4>
                        <p class="text-sm text-gray-600">服务器配置、AI记忆管理和执行日志</p>
                    </div>
                    <a href="/mcp.html" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-md transition shadow-sm">
                        进入管理
                    </a>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-md mt-8">
            <h3 class="text-xl font-semibold text-gray-900 border-b pb-3 mb-4">密码管理</h3>
            <form id="password-change-form" onsubmit="changePassword(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="current_password" class="block text-sm font-medium text-gray-700">当前密码</label>
                        <input type="password" id="current_password" name="current_password" autocomplete="current-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="new_password" class="block text-sm font-medium text-gray-700">新密码 (1-4位数字)</label>
                        <input type="password" id="new_password" name="new_password" maxlength="4" pattern="[0-9]{1,4}" autocomplete="new-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
                <button type="submit" class="mt-4 px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition">
                    修改密码
                </button>
            </form>
        </div>

        <footer class="mt-8 flex items-center justify-end space-x-3">
            <button onclick="testAI()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">测试 AI</button>
            <button onclick="testTelegram()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">测试 Telegram</button>
            <button onclick="saveConfig()" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">保存配置</button>
        </footer>
    </div>
    <div id="toast-container" class="fixed bottom-5 right-5 space-y-2"></div>
</div>
<script>
function showToast(message, isSuccess = true) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast p-4 rounded-lg shadow-lg text-white ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

async function loadConfig() {
    try {
        const res = await fetch('/api/configs');
        if (!res.ok) throw new Error(`无法加载配置: ${res.statusText}`);
        const data = await res.json();
        if (data.success) {
            const map = {};
            data.configs.forEach(c => map[c.key] = c.value);
            document.getElementById('ai_api_url').value = map['ai_api_url'] || '';
            document.getElementById('ai_api_key').value = map['ai_api_key'] || '';
            document.getElementById('ai_model').value = map['ai_model'] || '';
            document.getElementById('ai_prompt_template').value = map['ai_prompt_template'] || '';
            document.getElementById('ai_summary_prompt').value = map['ai_summary_prompt'] || '';
            document.getElementById('telegram_bot_token').value = map['telegram_bot_token'] || '';
            document.getElementById('telegram_chat_id').value = map['telegram_chat_id'] || '';
            document.getElementById('telegram_enabled').checked = map['telegram_enabled'] === 'true';
        } else {
            throw new Error(data.message || '加载配置失败');
        }
    } catch (error) {
        showToast(error.message, false);
    }
}

const loadingIcon = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
  </svg>`;

async function saveConfig() {
    const button = event.target;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `${loadingIcon} 正在保存...`;

    try {
        const configs = [
            { key: 'ai_api_url', value: document.getElementById('ai_api_url').value },
            { key: 'ai_api_key', value: document.getElementById('ai_api_key').value },
            { key: 'ai_model', value: document.getElementById('ai_model').value },
            { key: 'ai_prompt_template', value: document.getElementById('ai_prompt_template').value },
            { key: 'ai_summary_prompt', value: document.getElementById('ai_summary_prompt').value },
            { key: 'telegram_bot_token', value: document.getElementById('telegram_bot_token').value },
            { key: 'telegram_chat_id', value: document.getElementById('telegram_chat_id').value },
            { key: 'telegram_enabled', value: document.getElementById('telegram_enabled').checked ? 'true' : 'false' }
        ];
        const res = await fetch('/api/configs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(configs)
        });
        const data = await res.json();
        if (data.success) {
            showToast('配置已成功保存！');
        } else {
            showToast(`保存失败: ${data.message}`, false);
        }
    } catch (error) {
        showToast(`发生错误: ${error.message}`, false);
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

async function changePassword(event) {
    event.preventDefault();
    
    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    
    if (!currentPassword || !newPassword) {
        showToast('请填写当前密码和新密码', false);
        return;
    }
    
    if (!/^[0-9]{1,4}$/.test(newPassword)) {
        showToast('新密码必须是1-4位数字', false);
        return;
    }

    try {
        const res = await fetch('/api/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                current_password: currentPassword,
                new_password: newPassword 
            })
        });
        const data = await res.json();
        if (data.success) {
            showToast('密码修改成功！');
            document.getElementById('password-change-form').reset();
        } else {
            showToast(`密码修改失败: ${data.message}`, false);
        }
    } catch (error) {
        showToast(`发生错误: ${error.message}`, false);
    }
}

async function testAI() {
    const button = event.target;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `${loadingIcon.replace('text-white', 'text-gray-700')} 正在测试...`;
    showToast('正在测试 AI 连接...');

    try {
        const res = await fetch('/api/admin/test-ai', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: '连接测试' })
        });
        const data = await res.json();
        if (res.ok && data.success) {
            showToast(`AI 测试成功: ${data.message || data.result}`);
        } else {
            showToast(`AI 测试失败: ${data.message || '未知错误'}`, false);
        }
    } catch (error) {
        showToast(`发生错误: ${error.message}`, false);
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

async function testTelegram() {
    const button = event.target;
    const originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = `${loadingIcon.replace('text-white', 'text-gray-700')} 正在测试...`;
    showToast('正在测试 Telegram 连接...');

    try {
        const res = await fetch('/api/admin/test-telegram', { method: 'POST' });
        const data = await res.json();
        if (res.ok && data.success) {
            showToast(`Telegram 测试成功: ${data.message}`);
        } else {
            showToast(`Telegram 测试失败: ${data.message || '未知错误'}`, false);
        }
    } catch (error) {
        showToast(`发生错误: ${error.message}`, false);
    } finally {
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

function goBack(){
    if (window.parent && window.parent.closeSettings) {
        window.parent.closeSettings();
    } else {
        window.location.href = '/';
    }
}

// 页面加载时直接加载配置，不需要登录验证
loadConfig();
</script>
</body>
</html>
